<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Nervioso 3D ‚Äî Plataforma M√©dica In Silico</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#080810;--panel:rgba(10,10,20,0.88);--card:rgba(16,16,32,0.75);--accent:#d4c45a;--accent-glow:rgba(212,196,90,0.25);--cyan:#5cc8d4;--cyan-glow:rgba(92,200,212,0.2);--nerve:#e8d44a;--nerve-glow:rgba(232,212,74,0.3);--text:#e8ecf4;--text2:#8a94a8;--dim:#555f73;--border:rgba(255,255,255,0.06);--glass:rgba(255,255,255,0.03)}
        body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;height:100vh}

        .header{position:fixed;top:0;left:0;right:0;height:52px;background:var(--panel);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:100}
        .header h1{font-size:.9rem;font-weight:600;letter-spacing:-.02em}
        .header span{font-family:'Space Mono',monospace;font-size:.6rem;color:var(--dim);text-transform:uppercase;letter-spacing:.1em}
        .header-r{display:flex;align-items:center;gap:14px}
        .sdot{width:6px;height:6px;border-radius:50%;background:#4ade80;box-shadow:0 0 8px rgba(74,222,128,.5);animation:pd 2s infinite}
        @keyframes pd{0%,100%{opacity:1}50%{opacity:.5}}
        .fps{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--dim)}

        #mainCanvas{position:fixed;top:52px;left:0;width:100%;height:calc(100vh - 52px)}

        .loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .8s,visibility .8s}
        .loading-screen.hidden{opacity:0;visibility:hidden;pointer-events:none}
        .lb-icon{font-size:3.5rem;animation:fl 2s ease-in-out infinite}
        @keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .lb-bar{width:180px;height:2px;background:var(--border);border-radius:2px;margin-top:20px;overflow:hidden}
        .lb-fill{height:100%;background:linear-gradient(90deg,var(--nerve),var(--cyan));width:0%;transition:width .3s;border-radius:2px}
        .lb-txt{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--dim);margin-top:10px}

        .info-panel{position:fixed;top:66px;right:14px;width:290px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:14px;padding:18px;z-index:50;transition:transform .4s cubic-bezier(.16,1,.3,1),opacity .4s}
        .info-panel.hide{transform:translateX(310px);opacity:0}
        .ip-tag{font-size:.6rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.12em;color:var(--accent);margin-bottom:10px}
        .ip-name{font-size:1.3rem;font-weight:700;letter-spacing:-.03em;margin-bottom:3px}
        .ip-sys{font-size:.78rem;color:var(--cyan);margin-bottom:10px}
        .ip-desc{font-size:.78rem;line-height:1.5;color:var(--text2);margin-bottom:14px}
        .ip-stats{display:grid;grid-template-columns:1fr 1fr;gap:7px}
        .st-card{background:var(--glass);border:1px solid var(--border);border-radius:9px;padding:9px 10px}
        .st-label{font-size:.6rem;color:var(--dim);font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.05em}
        .st-val{font-size:.85rem;font-weight:600;margin-top:1px}

        .hl-panel{position:fixed;top:66px;left:14px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:12px;z-index:50;max-height:calc(100vh - 160px);overflow-y:auto}
        .hl-panel::-webkit-scrollbar{width:4px}
        .hl-panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
        .hl-title{font-size:.6rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:8px}
        .hl-sep{font-size:.55rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin:8px 0 4px 10px;opacity:.6}
        .hl-btn{display:flex;align-items:center;gap:8px;width:100%;padding:7px 10px;border:1px solid transparent;border-radius:7px;background:0 0;color:var(--text2);font-size:.78rem;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;margin-bottom:2px}
        .hl-btn:hover{background:var(--glass);color:var(--text)}
        .hl-btn.active{background:var(--cyan-glow);border-color:rgba(92,200,212,.3);color:var(--cyan)}
        .hl-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

        .ctrl-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:5px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:7px;z-index:50}
        .cb{width:40px;height:40px;border-radius:9px;border:1px solid transparent;background:0 0;color:var(--text2);font-size:1.05rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .cb:hover{background:var(--glass);border-color:var(--border);color:var(--text)}
        .cb.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
        .cd{width:1px;background:var(--border);margin:4px 1px}

        .pp-panel{position:fixed;bottom:75px;left:50%;transform:translateX(-50%);background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:14px;z-index:50;min-width:220px;display:none}
        .pp-panel.vis{display:block}
        .pp-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
        .pp-row label{font-size:.72rem;color:var(--text2)}
        .pp-row input[type=range]{width:100px;height:3px;-webkit-appearance:none;background:var(--border);border-radius:2px;outline:0}
        .pp-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--accent);cursor:pointer}

        .credit{position:fixed;bottom:70px;right:14px;font-size:.55rem;color:var(--dim);font-family:'Space Mono',monospace;z-index:50;text-align:right;line-height:1.4}
        .credit a{color:var(--dim);text-decoration:underline;text-decoration-color:rgba(255,255,255,.1)}

        /* Neural impulse indicator */
        .impulse-bar{position:fixed;top:66px;left:50%;transform:translateX(-50%);background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:10px;padding:6px 16px;z-index:50;display:flex;align-items:center;gap:10px}
        .impulse-dot{width:6px;height:6px;border-radius:50%;background:var(--nerve);box-shadow:0 0 8px var(--nerve-glow)}
        @keyframes impulseFire{0%{opacity:.4;box-shadow:0 0 4px var(--nerve-glow)}50%{opacity:1;box-shadow:0 0 14px var(--nerve-glow)}100%{opacity:.4;box-shadow:0 0 4px var(--nerve-glow)}}
        .impulse-dot{animation:impulseFire .8s ease-in-out infinite}
        .impulse-lbl{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--dim)}
        .impulse-val{font-family:'Space Mono',monospace;font-size:.7rem;color:var(--nerve)}
    </style>
</head>
<body>
    <div class="loading-screen" id="ls">
        <div class="lb-icon">üß†</div>
        <div class="lb-bar"><div class="lb-fill" id="lbFill"></div></div>
        <div class="lb-txt" id="lbTxt">Inicializando...</div>
    </div>

    <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
            <!-- BOT√ìN VOLVER -->
            <button onclick="history.back()" style="background:none;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:4px 8px;color:#8a94a8;cursor:pointer;font-size:1.1rem;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)';this.style.color='#e8ecf4'" onmouseout="this.style.background='none';this.style.color='#8a94a8'" title="Volver atr√°s">‚Üê</button>
            
            <span style="font-size:1.3rem">‚ö°</span>
            <div><h1>Plataforma M√©dica In Silico</h1><span>Modelo Anat√≥mico 3D ‚Äî Sistema Nervioso</span></div>
        </div>
        <div class="header-r"><div class="fps" id="fps">-- FPS</div><div class="sdot"></div></div>
    </div>

    <canvas id="mainCanvas"></canvas>

    <div class="impulse-bar">
        <div class="impulse-dot"></div>
        <div class="impulse-lbl">Vel. impulso</div>
        <div class="impulse-val" id="impVal">~120 m/s</div>
    </div>

    <div class="hl-panel">
        <div class="hl-title">Estructuras</div>
        <button class="hl-btn active" data-part="all"><span class="hl-dot" style="background:#d4c45a"></span>Sistema completo</button>
        <div class="hl-sep">‚Äî Visualizaci√≥n ‚Äî</div>
        <button class="hl-btn" data-part="nerves"><span class="hl-dot" style="background:#e8d44a"></span>Solo nervios</button>
        <button class="hl-btn" data-part="body"><span class="hl-dot" style="background:rgba(180,170,160,0.4)"></span>Solo cuerpo</button>
        <button class="hl-btn" data-part="labels"><span class="hl-dot" style="background:#88bbdd"></span>Etiquetas</button>
        <div class="hl-sep">‚Äî SNC ‚Äî</div>
        <button class="hl-btn" data-part="brain"><span class="hl-dot" style="background:#ddbb88"></span>Enc√©falo</button>
        <button class="hl-btn" data-part="spinal"><span class="hl-dot" style="background:#ccaa66"></span>M√©dula espinal</button>
        <div class="hl-sep">‚Äî SNP ‚Äî</div>
        <button class="hl-btn" data-part="cervical"><span class="hl-dot" style="background:#eecc55"></span>Plexo cervical</button>
        <button class="hl-btn" data-part="brachial"><span class="hl-dot" style="background:#ddbb44"></span>Plexo braquial</button>
        <button class="hl-btn" data-part="lumbar"><span class="hl-dot" style="background:#ccaa33"></span>Plexo lumbosacro</button>
        <button class="hl-btn" data-part="sciatic"><span class="hl-dot" style="background:#bb9922"></span>Nervio ci√°tico</button>
        <div class="hl-sep">‚Äî Divisiones ‚Äî</div>
        <button class="hl-btn" data-part="autonomic"><span class="hl-dot" style="background:#88cc88"></span>SN Aut√≥nomo</button>
        <button class="hl-btn" data-part="cranial"><span class="hl-dot" style="background:#cc88dd"></span>Nervios craneales</button>
    </div>

    <div class="info-panel" id="ip">
        <div class="ip-tag">Informaci√≥n Anat√≥mica</div>
        <div class="ip-name" id="ipN">Sistema Nervioso</div>
        <div class="ip-sys" id="ipS">Red de Control y Comunicaci√≥n</div>
        <div class="ip-desc" id="ipD">Red de comunicaci√≥n del organismo. Se divide en sistema nervioso central (enc√©falo y m√©dula espinal) y sistema nervioso perif√©rico (nervios craneales, espinales y ganglios). Controla funciones voluntarias, involuntarias, sensoriales y cognitivas.</div>
        <div class="ip-stats" id="ipSt">
            <div class="st-card"><div class="st-label">Neuronas</div><div class="st-val">~86√ó10‚Åπ</div></div>
            <div class="st-card"><div class="st-label">Sinapsis</div><div class="st-val">~150√ó10¬π¬≤</div></div>
            <div class="st-card"><div class="st-label">Vel. m√°xima</div><div class="st-val">~120 m/s</div></div>
            <div class="st-card"><div class="st-label">N. espinales</div><div class="st-val">31 pares</div></div>
        </div>
    </div>

    <div class="ctrl-bar">
        <button class="cb active" id="bRot" title="Auto-rotaci√≥n">üîÑ</button>
        <button class="cb" id="bRst" title="Reset">üè†</button>
        <div class="cd"></div>
        <button class="cb" id="bZi" title="Zoom +">‚ûï</button>
        <button class="cb" id="bZo" title="Zoom -">‚ûñ</button>
        <div class="cd"></div>
        <button class="cb" id="bFr" title="Anterior">üë§</button>
        <button class="cb" id="bTo" title="Superior">‚¨ÜÔ∏è</button>
        <button class="cb" id="bSi" title="Lateral">üëà</button>
        <button class="cb" id="bBk" title="Posterior">üîô</button>
        <div class="cd"></div>
        <button class="cb" id="bPP" title="Efectos">‚ú®</button>
        <button class="cb" id="bIn" title="Info">üìã</button>
    </div>

    <div class="pp-panel" id="ppP">
        <div class="hl-title">Post-Processing</div>
        <div class="pp-row"><label>Bloom</label><input type="range" id="ppB" min="0" max="100" value="20"></div>
        <div class="pp-row"><label>Exposici√≥n</label><input type="range" id="ppE" min="50" max="200" value="115"></div>
        <div class="pp-row"><label>SSS</label><input type="range" id="ppS" min="0" max="100" value="15"></div>
        <div class="pp-row"><label>Vignette</label><input type="range" id="ppV" min="0" max="100" value="30"></div>
    </div>

    <div class="credit">Modelo: <a href="https://sketchfab.com/3d-models/nervous-system-b4c0239fe0a34bbb92606f8a5248d0fa" target="_blank">"Nervous System"</a> por brianj.seely<br>CC-BY-4.0</div>

    <script type="importmap">
    {"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"}}
    </script>
    <script type="module">
import * as THREE from 'three';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {EffectComposer} from 'three/addons/postprocessing/EffectComposer.js';
import {RenderPass} from 'three/addons/postprocessing/RenderPass.js';
import {UnrealBloomPass} from 'three/addons/postprocessing/UnrealBloomPass.js';
import {ShaderPass} from 'three/addons/postprocessing/ShaderPass.js';
import {SMAAPass} from 'three/addons/postprocessing/SMAAPass.js';

const $=id=>document.getElementById(id);
const lbFill=$('lbFill'), lbTxt=$('lbTxt'), ls=$('ls');
const setLoad=(p,t)=>{lbFill.style.width=p+'%';lbTxt.textContent=t};

setLoad(10,'Configurando escena...');
const canvas=$('mainCanvas');
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x080810);
scene.fog=new THREE.FogExp2(0x080810, 0.025);

const camera=new THREE.PerspectiveCamera(45, innerWidth/(innerHeight-52), 0.01, 100);
camera.position.set(3, 2, 5);

const renderer=new THREE.WebGLRenderer({canvas, antialias:true, powerPreference:'high-performance'});
renderer.setSize(innerWidth, innerHeight-52);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.15;
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.useLegacyLights=false;

const ctrl=new OrbitControls(camera, canvas);
ctrl.enableDamping=true; ctrl.dampingFactor=0.06;
ctrl.rotateSpeed=0.7; ctrl.zoomSpeed=0.8;
ctrl.minDistance=1.5; ctrl.maxDistance=14;
ctrl.target.set(0, 0, 0);
ctrl.autoRotate=true; ctrl.autoRotateSpeed=0.5;

// ===== ENVIRONMENT =====
setLoad(20,'Generando environment...');
const pmrem=new THREE.PMREMGenerator(renderer);
pmrem.compileEquirectangularShader();
const envSc=new THREE.Scene();
envSc.add(new THREE.Mesh(
    new THREE.SphereGeometry(10, 32, 32),
    new THREE.ShaderMaterial({
        side: THREE.BackSide,
        vertexShader:`varying vec3 vP;void main(){vP=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
        fragmentShader:`varying vec3 vP;void main(){
            vec3 d=normalize(vP);float y=d.y*.5+.5;
            vec3 c=mix(vec3(.03,.03,.06),mix(vec3(.05,.05,.1),vec3(.08,.08,.14),smoothstep(.4,1.,y)),smoothstep(0.,.4,y));
            c+=vec3(.25,.22,.1)*pow(max(0.,dot(d,normalize(vec3(1.,.4,.5)))),7.)*.2;
            c+=vec3(.08,.08,.15)*pow(max(0.,dot(d,normalize(vec3(-.7,.3,-.6)))),5.)*.15;
            gl_FragColor=vec4(c,1.);}`
    })
));
scene.environment=pmrem.fromScene(envSc, 0.04).texture;
pmrem.dispose();

// ===== LIGHTS =====
setLoad(30,'Iluminaci√≥n...');
scene.add(new THREE.HemisphereLight(0x8888aa, 0x111122, 0.5));

const keyLight=new THREE.DirectionalLight(0xffeedd, 2.5);
keyLight.position.set(4, 6, 5);
keyLight.castShadow=true;
keyLight.shadow.mapSize.set(2048, 2048);
keyLight.shadow.camera.near=0.1; keyLight.shadow.camera.far=20;
keyLight.shadow.camera.left=-5; keyLight.shadow.camera.right=5;
keyLight.shadow.camera.top=8; keyLight.shadow.camera.bottom=-8;
keyLight.shadow.bias=-0.0005; keyLight.shadow.normalBias=0.02;
scene.add(keyLight);

const fillLight=new THREE.DirectionalLight(0x6688bb, 0.8);
fillLight.position.set(-5, 3, -2);
scene.add(fillLight);

const rimLight=new THREE.DirectionalLight(0xddcc88, 1.4);
rimLight.position.set(-2, -1, -5);
scene.add(rimLight);

// Neural glow light
const nerveLight=new THREE.PointLight(0xe8d44a, 0.4, 12);
nerveLight.position.set(0, 2, 3);
scene.add(nerveLight);

const sssLight=new THREE.PointLight(0xddbb55, 0.3, 10);
sssLight.position.set(0, -4, 2);
scene.add(sssLight);

// ===== POST-PROCESSING =====
setLoad(40,'Post-processing...');
const composer=new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));

const bloom=new UnrealBloomPass(
    new THREE.Vector2(innerWidth, innerHeight), 0.2, 0.5, 0.82
);
composer.addPass(bloom);

const cgShader={
    uniforms:{tDiffuse:{value:null}, sss:{value:0.15}, vign:{value:0.3}},
    vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
    fragmentShader:`uniform sampler2D tDiffuse;uniform float sss;uniform float vign;varying vec2 vUv;
    void main(){
        vec4 tx=texture2D(tDiffuse,vUv);vec3 c=tx.rgb;
        float lum=dot(c,vec3(.299,.587,.114));
        float sm=smoothstep(.1,.5,lum)*(1.-smoothstep(.5,.9,lum));
        c+=vec3(.7,.65,.3)*sss*sm*.12;
        float g=dot(c,vec3(.2126,.7152,.0722));c=mix(vec3(g),c,1.08);
        c=(c-.5)*1.04+.5;
        vec2 u=vUv*2.-1.;c*=1.-dot(u,u)*vign*.4;
        gl_FragColor=vec4(clamp(c,0.,1.),tx.a);}`
};
const cgPass=new ShaderPass(cgShader);
composer.addPass(cgPass);
composer.addPass(new SMAAPass(innerWidth, innerHeight));

// ===== LOAD MODEL =====
setLoad(50,'Cargando sistema nervioso...');
let model=null;
// mesh0=body(skin), mesh1=nerves, mesh2-4=labels
const parts = { body: null, nerves: null, labels: [] };

new GLTFLoader().load('nervous.glb',
    (gltf) => {
        setLoad(80,'Mejorando materiales...');
        model = gltf.scene;

        const box = new THREE.Box3().setFromObject(model);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        const sc = 5.0 / Math.max(size.x, size.y, size.z);
        model.scale.setScalar(sc);

        const scaledBox = new THREE.Box3().setFromObject(model);
        const scaledCenter = scaledBox.getCenter(new THREE.Vector3());
        model.position.x -= scaledCenter.x;
        model.position.y -= scaledCenter.y;
        model.position.z -= scaledCenter.z;

        let meshIdx = 0;
        model.traverse((child) => {
            if (!child.isMesh) return;
            child.castShadow = true;
            child.receiveShadow = true;

            const idx = meshIdx++;

            if (idx === 0) {
                // Body/Skin ‚Äî semi-transparent
                parts.body = child;
                const pm = new THREE.MeshPhysicalMaterial({
                    color: new THREE.Color(0.75, 0.65, 0.6),
                    roughness: 0.7,
                    metalness: 0.0,
                    transparent: true,
                    opacity: 0.25,
                    depthWrite: false,
                    side: THREE.DoubleSide,
                    envMapIntensity: 0.3
                });
                child.material = pm;
            } else if (idx === 1) {
                // Nervous system
                parts.nerves = child;
                const mat = child.material;
                const pm = new THREE.MeshPhysicalMaterial();
                if (mat.map) pm.map = mat.map;
                if (mat.normalMap) { pm.normalMap = mat.normalMap; pm.normalScale = new THREE.Vector2(1.5, 1.5); }
                if (mat.roughnessMap) pm.roughnessMap = mat.roughnessMap;
                if (mat.metalnessMap) pm.metalnessMap = mat.metalnessMap;

                pm.roughness = 0.45;
                pm.metalness = 0.05;
                pm.clearcoat = 0.2;
                pm.clearcoatRoughness = 0.3;
                pm.emissive = new THREE.Color(0.35, 0.3, 0.08);
                pm.emissiveIntensity = 0.15;
                pm.sheen = 0.3;
                pm.sheenRoughness = 0.4;
                pm.sheenColor = new THREE.Color(0.9, 0.85, 0.4);
                pm.envMapIntensity = 0.6;
                child.material = pm;
            } else {
                // Labels
                parts.labels.push(child);
                child.visible = true;
            }
        });

        scene.add(model);

        const gnd = new THREE.Mesh(
            new THREE.PlaneGeometry(20, 20),
            new THREE.MeshStandardMaterial({color:0x080810, roughness:0.95, transparent:true, opacity:0.4})
        );
        gnd.rotation.x = -Math.PI / 2;
        gnd.position.y = scaledBox.min.y - 0.1;
        gnd.receiveShadow = true;
        scene.add(gnd);

        setLoad(100, '¬°Listo!');
        setTimeout(() => ls.classList.add('hidden'), 500);
    },
    (p) => { if(p.total) setLoad(50 + (p.loaded / p.total) * 30, 'Descargando... ' + (p.loaded / 1024 | 0) + 'KB') },
    (e) => { console.error(e); setLoad(0, 'Error al cargar. Verifica que nervous.glb est√© en la misma carpeta.') }
);

// ===== NEURAL IMPULSE ANIMATION =====
let lt = performance.now(), fc = 0;
(function anim(t) {
    requestAnimationFrame(anim);
    fc++;
    if (t - lt >= 1000) { $('fps').textContent = fc + ' FPS'; fc = 0; lt = t; }
    ctrl.update();

    // Pulsing nerve glow
    if (parts.nerves && parts.nerves.material) {
        const pulse = 0.15 + Math.sin(t * 0.002) * 0.05 + Math.sin(t * 0.005) * 0.03;
        parts.nerves.material.emissiveIntensity = pulse;
    }
    nerveLight.intensity = 0.4 + Math.sin(t * 0.003) * 0.15;
    sssLight.intensity = 0.3 + Math.sin(t * 0.001) * 0.06;

    // Impulse speed variation
    const speed = 120 + Math.round(Math.sin(t * 0.0004) * 10);
    $('impVal').textContent = '~' + speed + ' m/s';

    composer.render();
})(0);

// ‚ïê‚ïê‚ïê AGREGADO: Exponer engine para m√≥dulos externos ‚ïê‚ïê‚ïê
window.__NERVOUS3D = { scene, camera, renderer, ctrl };

addEventListener('resize', () => {
    const w = innerWidth, h = innerHeight - 52;
    camera.aspect = w / h; camera.updateProjectionMatrix();
    renderer.setSize(w, h); composer.setSize(w, h); bloom.setSize(w, h);
});

// ===== UI =====
let ar = true;
$('bRot').onclick = e => { ar = !ar; ctrl.autoRotate = ar; e.currentTarget.classList.toggle('active', ar); };
$('bRst').onclick = () => { ctrl.target.set(0, 0, 0); camera.position.set(3, 2, 5); };
$('bZi').onclick = () => camera.position.lerp(ctrl.target, 0.15);
$('bZo').onclick = () => { const d = camera.position.clone().sub(ctrl.target).normalize(); camera.position.add(d.multiplyScalar(0.5)); };
$('bFr').onclick = () => { camera.position.set(0, 0, 6); ctrl.target.set(0, 0, 0); };
$('bTo').onclick = () => { camera.position.set(0, 7, 0.01); ctrl.target.set(0, 0, 0); };
$('bSi').onclick = () => { camera.position.set(6, 0, 0); ctrl.target.set(0, 0, 0); };
$('bBk').onclick = () => { camera.position.set(0, 0, -6); ctrl.target.set(0, 0, 0); };

let ipVis = true;
$('bIn').onclick = () => { ipVis = !ipVis; $('ip').classList.toggle('hide', !ipVis); };

$('bPP').onclick = e => { $('ppP').classList.toggle('vis'); e.currentTarget.classList.toggle('active'); };
$('ppB').oninput = e => bloom.strength = e.target.value / 100 * 0.5;
$('ppE').oninput = e => renderer.toneMappingExposure = e.target.value / 100;
$('ppS').oninput = e => cgPass.uniforms.sss.value = e.target.value / 100;
$('ppV').oninput = e => cgPass.uniforms.vign.value = e.target.value / 100;

// ===== HIGHLIGHT =====
function setHighlight(sel) {
    const body = parts.body, nerves = parts.nerves, labels = parts.labels;
    if (!body || !nerves) return;

    const bm = body.material, nm = nerves.material;

    switch(sel) {
        case 'all':
            bm.opacity = 0.25; bm.visible = true;
            nm.opacity = 1; nm.transparent = false; nm.depthWrite = true; nm.visible = true;
            labels.forEach(l => l.visible = true);
            break;
        case 'nerves':
            bm.opacity = 0.06; bm.visible = true;
            nm.opacity = 1; nm.transparent = false; nm.depthWrite = true; nm.visible = true;
            labels.forEach(l => l.visible = false);
            break;
        case 'body':
            bm.opacity = 0.7; bm.visible = true;
            nm.opacity = 0.15; nm.transparent = true; nm.depthWrite = false; nm.visible = true;
            labels.forEach(l => l.visible = false);
            break;
        case 'labels':
            bm.opacity = 0.1; bm.visible = true;
            nm.opacity = 0.8; nm.transparent = true; nm.depthWrite = true; nm.visible = true;
            labels.forEach(l => l.visible = true);
            break;
        default:
            // Educational sections ‚Äî show nerves prominently
            bm.opacity = 0.12; bm.visible = true;
            nm.opacity = 1; nm.transparent = false; nm.depthWrite = true; nm.visible = true;
            labels.forEach(l => l.visible = false);
            break;
    }
}

// ===== PART INFO =====
const partInfo = {
    all:{n:'Sistema Nervioso',s:'Red de Control y Comunicaci√≥n',
        d:'Red de comunicaci√≥n del organismo. Se divide en sistema nervioso central (enc√©falo y m√©dula espinal) y sistema nervioso perif√©rico (nervios craneales, espinales y ganglios). Controla funciones voluntarias, involuntarias, sensoriales y cognitivas.',
        st:[{l:'Neuronas',v:'~86√ó10‚Åπ'},{l:'Sinapsis',v:'~150√ó10¬π¬≤'},{l:'Vel. m√°xima',v:'~120 m/s'},{l:'N. espinales',v:'31 pares'}]},
    nerves:{n:'Red Nerviosa',s:'Fibras Nerviosas Perif√©ricas',
        d:'Conjunto de nervios que se ramifican desde el sistema nervioso central hacia todo el cuerpo. Incluyen fibras motoras (eferentes), sensoriales (aferentes) y auton√≥micas.',
        st:[{l:'Tipo fibras',v:'AŒ±, AŒ≤, AŒ¥, C'},{l:'Mielina',v:'‚Üë velocidad'},{l:'Ganglios',v:'Dorsales/Aut√≥n.'},{l:'Dermatomas',v:'~30'}]},
    body:{n:'Cuerpo de Referencia',s:'Silueta Anat√≥mica',
        d:'Silueta del cuerpo humano que muestra la disposici√≥n espacial del sistema nervioso, permitiendo visualizar la relaci√≥n entre las estructuras nerviosas y la anatom√≠a de superficie.',
        st:[{l:'Funci√≥n',v:'Referencia'},{l:'Tipo',v:'Silueta'},{l:'Uso',v:'Orientaci√≥n'},{l:'Modo',v:'Transparente'}]},
    labels:{n:'Etiquetas Anat√≥micas',s:'Identificadores',
        d:'Marcadores que identifican las principales estructuras del sistema nervioso visible en el modelo, facilitando el estudio y la orientaci√≥n anat√≥mica.',
        st:[{l:'Tipo',v:'Indicadores'},{l:'Funci√≥n',v:'Identificaci√≥n'},{l:'Formato',v:'Texto 3D'},{l:'Idioma',v:'Nomenclatura'}]},
    brain:{n:'Enc√©falo',s:'SNC ‚Äî Centro de Integraci√≥n',
        d:'√ìrgano central del sistema nervioso protegido por el cr√°neo. Comprende el cerebro (telenc√©falo y dienc√©falo), cerebelo y tronco encef√°lico. Procesa informaci√≥n sensorial, controla el movimiento, genera pensamiento, emoci√≥n y conciencia.',
        st:[{l:'Peso',v:'~1.4 kg'},{l:'Neuronas',v:'~86√ó10‚Åπ'},{l:'Consumo O‚ÇÇ',v:'20%'},{l:'L√≥bulos',v:'4 √ó hemisf.'}]},
    spinal:{n:'M√©dula Espinal',s:'SNC ‚Äî V√≠a de Conducci√≥n',
        d:'Cord√≥n nervioso alojado en el canal vertebral, desde el foramen magno hasta L1-L2 (cono medular). Conduce informaci√≥n entre el enc√©falo y el cuerpo, y es centro de los arcos reflejos espinales.',
        st:[{l:'Longitud',v:'~45 cm'},{l:'Segmentos',v:'31'},{l:'Terminaci√≥n',v:'L1-L2'},{l:'Cola de caballo',v:'Debajo L2'}]},
    cervical:{n:'Plexo Cervical',s:'SNP ‚Äî C1 a C4',
        d:'Formado por las ramas anteriores de C1-C4. Inerva la piel y m√∫sculos del cuello, la regi√≥n supraclavicular y el diafragma (nervio fr√©nico C3-C5). El nervio fr√©nico es esencial para la respiraci√≥n.',
        st:[{l:'Ra√≠ces',v:'C1-C4'},{l:'N. fr√©nico',v:'C3-C5'},{l:'Inerva',v:'Cuello/Diafragma'},{l:'Ramos',v:'Cut√°neos + mot.'}]},
    brachial:{n:'Plexo Braquial',s:'SNP ‚Äî C5 a T1',
        d:'Red nerviosa que inerva la extremidad superior. Formado por ra√≠ces, troncos, divisiones, fasc√≠culos y nervios terminales (musculocut√°neo, mediano, cubital, radial y axilar).',
        st:[{l:'Ra√≠ces',v:'C5-T1'},{l:'N. mediano',v:'Cara anterior'},{l:'N. cubital',v:'Lado medial'},{l:'N. radial',v:'Cara posterior'}]},
    lumbar:{n:'Plexo Lumbosacro',s:'SNP ‚Äî L1 a S4',
        d:'Combinaci√≥n de los plexos lumbar (L1-L4) y sacro (L4-S4). Inerva la extremidad inferior, pelvis y perin√©. Nervios principales: femoral, obturador, ci√°tico, tibial y peroneo.',
        st:[{l:'P. lumbar',v:'L1-L4'},{l:'P. sacro',v:'L4-S4'},{l:'N. femoral',v:'Muslo anterior'},{l:'N. ci√°tico',v:'Mayor nervio'}]},
    sciatic:{n:'Nervio Ci√°tico',s:'Mayor Nervio del Cuerpo',
        d:'El nervio m√°s largo y grueso del cuerpo (~2 cm de di√°metro). Sale por el foramen ci√°tico mayor, desciende por la cara posterior del muslo y se bifurca en nervios tibial y peroneo com√∫n a nivel de la fosa popl√≠tea.',
        st:[{l:'Origen',v:'L4-S3'},{l:'Di√°metro',v:'~2 cm'},{l:'Bifurcaci√≥n',v:'Fosa popl√≠tea'},{l:'Ramas',v:'Tibial + Peroneo'}]},
    autonomic:{n:'SN Aut√≥nomo',s:'Control Involuntario',
        d:'Regula funciones involuntarias: frecuencia card√≠aca, digesti√≥n, respiraci√≥n, pupila, etc. Se divide en simp√°tico (lucha o huida), parasimp√°tico (reposo y digesti√≥n) y ent√©rico (intestinal).',
        st:[{l:'Simp√°tico',v:'T1-L2'},{l:'Parasimp√°tico',v:'Craneal + S2-S4'},{l:'Ent√©rico',v:'~500√ó10‚Å∂ neur.'},{l:'Funci√≥n',v:'Homeostasis'}]},
    cranial:{n:'Nervios Craneales',s:'12 Pares Craneales',
        d:'Doce pares de nervios que emergen directamente del enc√©falo. Inervan estructuras de cabeza y cuello (excepto el vago que llega al abdomen). Incluyen funciones sensoriales especiales (olfato, visi√≥n, gusto, audici√≥n).',
        st:[{l:'Pares',v:'12 (I-XII)'},{l:'Sensoriales',v:'I, II, VIII'},{l:'Motores',v:'III,IV,VI,XI,XII'},{l:'Mixtos',v:'V,VII,IX,X'}]}
};

document.querySelectorAll('.hl-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.hl-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const p = btn.dataset.part, info = partInfo[p];
        if (info) {
            $('ipN').textContent = info.n; $('ipS').textContent = info.s; $('ipD').textContent = info.d;
            $('ipSt').innerHTML = info.st.map(s=>`<div class="st-card"><div class="st-label">${s.l}</div><div class="st-val">${s.v}</div></div>`).join('');
        }
        setHighlight(p);
    };
});
    </script>
    <!-- Labels (sistema numerado) -->
    <script type="module" src="../js/labels/nervous/nervous_labels.js"></script>

    <!-- Datos m√©dicos -->
    <script src="../js/labels/nervous/nervous_anatomia.js"></script>
    <script src="../js/labels/nervous/nervous_fisiologia.js"></script>
    <script src="../js/labels/nervous/nervous_patologias.js"></script>
    <script src="../js/labels/nervous/nervous_nutricion.js"></script>
    <script src="../js/labels/nervous/nervous_habitos.js"></script>
    <script src="../js/labels/nervous/nervous_clinicos.js"></script>
    <script type="module" src="../js/labels/nervous/nervous_medical_info.js"></script>
</body>
</html>