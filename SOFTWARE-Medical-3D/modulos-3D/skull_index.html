<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√°neo Humano 3D ‚Äî Plataforma M√©dica In Silico</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#09090b;--panel:rgba(11,11,14,0.90);--card:rgba(18,18,24,0.75);--accent:#b8a078;--accent-glow:rgba(184,160,120,0.22);--cyan:#60b8c0;--cyan-glow:rgba(96,184,192,0.18);--text:#e6e2da;--text2:#96908a;--dim:#5e5850;--border:rgba(255,255,255,0.06);--glass:rgba(255,255,255,0.03)}
        body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;height:100vh}

        .header{position:fixed;top:0;left:0;right:0;height:52px;background:var(--panel);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:100}
        .header h1{font-size:.9rem;font-weight:600;letter-spacing:-.02em}
        .header span{font-family:'Space Mono',monospace;font-size:.6rem;color:var(--dim);text-transform:uppercase;letter-spacing:.1em}
        .header-r{display:flex;align-items:center;gap:14px}
        .sdot{width:6px;height:6px;border-radius:50%;background:#4ade80;box-shadow:0 0 8px rgba(74,222,128,.5);animation:pd 2s infinite}
        @keyframes pd{0%,100%{opacity:1}50%{opacity:.5}}
        .fps{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--dim)}

        #mainCanvas{position:fixed;top:52px;left:0;width:100%;height:calc(100vh - 52px)}

        .loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .8s,visibility .8s}
        .loading-screen.hidden{opacity:0;visibility:hidden;pointer-events:none}
        .lb-icon{font-size:3.5rem;animation:fl 2s ease-in-out infinite}
        @keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .lb-bar{width:180px;height:2px;background:var(--border);border-radius:2px;margin-top:20px;overflow:hidden}
        .lb-fill{height:100%;background:linear-gradient(90deg,#7a6848,var(--accent));width:0%;transition:width .3s;border-radius:2px}
        .lb-txt{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--dim);margin-top:10px}

        .info-panel{position:fixed;top:66px;right:14px;width:300px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:14px;padding:18px;z-index:50;transition:transform .4s cubic-bezier(.16,1,.3,1),opacity .4s}
        .info-panel.hide{transform:translateX(320px);opacity:0}
        .ip-tag{font-size:.6rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.12em;color:var(--accent);margin-bottom:10px}
        .ip-name{font-size:1.3rem;font-weight:700;letter-spacing:-.03em;margin-bottom:3px}
        .ip-sys{font-size:.78rem;color:var(--cyan);margin-bottom:10px}
        .ip-desc{font-size:.78rem;line-height:1.5;color:var(--text2);margin-bottom:14px}
        .ip-stats{display:grid;grid-template-columns:1fr 1fr;gap:7px}
        .st-card{background:var(--glass);border:1px solid var(--border);border-radius:9px;padding:9px 10px}
        .st-label{font-size:.6rem;color:var(--dim);font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.05em}
        .st-val{font-size:.85rem;font-weight:600;margin-top:1px}

        .hl-panel{position:fixed;top:66px;left:14px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:12px;z-index:50;max-height:calc(100vh - 160px);overflow-y:auto}
        .hl-panel::-webkit-scrollbar{width:4px}
        .hl-panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
        .hl-title{font-size:.6rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:8px}
        .hl-sep{font-size:.55rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin:8px 0 4px 10px;opacity:.6}
        .hl-btn{display:flex;align-items:center;gap:8px;width:100%;padding:7px 10px;border:1px solid transparent;border-radius:7px;background:0 0;color:var(--text2);font-size:.78rem;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;margin-bottom:2px}
        .hl-btn:hover{background:var(--glass);color:var(--text)}
        .hl-btn.active{background:var(--accent-glow);border-color:rgba(184,160,120,.3);color:var(--accent)}
        .hl-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

        .ctrl-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:5px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:7px;z-index:50}
        .cb{width:40px;height:40px;border-radius:9px;border:1px solid transparent;background:0 0;color:var(--text2);font-size:1.05rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .cb:hover{background:var(--glass);border-color:var(--border);color:var(--text)}
        .cb.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
        .cd{width:1px;background:var(--border);margin:4px 1px}

        .pp-panel{position:fixed;bottom:75px;left:50%;transform:translateX(-50%);background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:14px;z-index:50;min-width:220px;display:none}
        .pp-panel.vis{display:block}
        .pp-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
        .pp-row label{font-size:.72rem;color:var(--text2)}
        .pp-row input[type=range]{width:100px;height:3px;-webkit-appearance:none;background:var(--border);border-radius:2px;outline:0}
        .pp-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--accent);cursor:pointer}

        .credit{position:fixed;bottom:70px;right:14px;font-size:.55rem;color:var(--dim);font-family:'Space Mono',monospace;z-index:50;text-align:right;line-height:1.4}
        .credit a{color:var(--dim);text-decoration:underline;text-decoration-color:rgba(255,255,255,.1)}
    </style>
</head>
<body>
    <div class="loading-screen" id="ls">
        <div class="lb-icon">üíÄ</div>
        <div class="lb-bar"><div class="lb-fill" id="lbFill"></div></div>
        <div class="lb-txt" id="lbTxt">Inicializando...</div>
    </div>

    <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:1.3rem">üíÄ</span>
            <div><h1>Plataforma M√©dica In Silico</h1><span>Modelo Anat√≥mico 3D ‚Äî Cr√°neo Humano (Estudio Anat√≥mico)</span></div>
        </div>
        <div class="header-r"><div class="fps" id="fps">-- FPS</div><div class="sdot"></div></div>
    </div>

    <canvas id="mainCanvas"></canvas>

    <div class="hl-panel">
        <div class="hl-title">Estructuras</div>
        <button class="hl-btn active" data-part="all"><span class="hl-dot" style="background:#b8a078"></span>Cr√°neo completo</button>
        <div class="hl-sep">‚Äî Divisiones ‚Äî</div>
        <button class="hl-btn" data-part="neurocranium"><span class="hl-dot" style="background:#d4c4a0"></span>Neurocr√°neo</button>
        <button class="hl-btn" data-part="viscerocranium"><span class="hl-dot" style="background:#c8a878"></span>Viscerocr√°neo</button>
        <button class="hl-btn" data-part="teeth"><span class="hl-dot" style="background:#f0ece4"></span>Dientes</button>
        <button class="hl-btn" data-part="sutures"><span class="hl-dot" style="background:#8a7e6e"></span>Suturas</button>
        <div class="hl-sep">‚Äî Neurocr√°neo ‚Äî</div>
        <button class="hl-btn" data-part="frontal"><span class="hl-dot" style="background:#d8c8a8"></span>H. Frontal</button>
        <button class="hl-btn" data-part="parietal"><span class="hl-dot" style="background:#d0c0a0"></span>HH. Parietales</button>
        <button class="hl-btn" data-part="temporal"><span class="hl-dot" style="background:#c8b898"></span>HH. Temporales</button>
        <button class="hl-btn" data-part="occipital"><span class="hl-dot" style="background:#c0b090"></span>H. Occipital</button>
        <button class="hl-btn" data-part="sphenoid"><span class="hl-dot" style="background:#b8a888"></span>H. Esfenoides</button>
        <button class="hl-btn" data-part="ethmoid"><span class="hl-dot" style="background:#b0a080"></span>H. Etmoides</button>
        <div class="hl-sep">‚Äî Viscerocr√°neo ‚Äî</div>
        <button class="hl-btn" data-part="maxilla"><span class="hl-dot" style="background:#d4b898"></span>Maxilares</button>
        <button class="hl-btn" data-part="mandible"><span class="hl-dot" style="background:#c8a880"></span>Mand√≠bula</button>
        <button class="hl-btn" data-part="zygomatic"><span class="hl-dot" style="background:#c0a078"></span>HH. Cigom√°ticos</button>
        <button class="hl-btn" data-part="nasal"><span class="hl-dot" style="background:#b89870"></span>HH. Nasales</button>
        <div class="hl-sep">‚Äî Regiones Cl√≠nicas ‚Äî</div>
        <button class="hl-btn" data-part="orbits"><span class="hl-dot" style="background:#60b8c0"></span>√ìrbitas</button>
        <button class="hl-btn" data-part="fossae"><span class="hl-dot" style="background:#88a8b0"></span>Fosas craneales</button>
        <button class="hl-btn" data-part="foramen"><span class="hl-dot" style="background:#a0a0b0"></span>Foramen magnum</button>
    </div>

    <div class="info-panel" id="ip">
        <div class="ip-tag">Informaci√≥n Anat√≥mica</div>
        <div class="ip-name" id="ipN">Cr√°neo Humano</div>
        <div class="ip-sys" id="ipS">Sistema Esquel√©tico ‚Äî Cabeza</div>
        <div class="ip-desc" id="ipD">Estructura √≥sea que protege el enc√©falo y aloja los √≥rganos de los sentidos. Compuesto por 22 huesos: 8 del neurocr√°neo (b√≥veda y base craneal) y 14 del viscerocr√°neo (esqueleto facial). Unidos por suturas (articulaciones fibrosas inm√≥viles) excepto la mand√≠bula, √∫nico hueso m√≥vil articulado por la ATM.</div>
        <div class="ip-stats" id="ipSt">
            <div class="st-card"><div class="st-label">Neurocr√°neo</div><div class="st-val">8 huesos</div></div>
            <div class="st-card"><div class="st-label">Viscerocr√°neo</div><div class="st-val">14 huesos</div></div>
            <div class="st-card"><div class="st-label">Capacidad</div><div class="st-val">~1400 cm¬≥</div></div>
            <div class="st-card"><div class="st-label">Dientes</div><div class="st-val">32 (adulto)</div></div>
        </div>
    </div>

    <div class="ctrl-bar">
        <button class="cb active" id="bRot" title="Auto-rotaci√≥n">üîÑ</button>
        <button class="cb" id="bRst" title="Reset">üè†</button>
        <div class="cd"></div>
        <button class="cb" id="bZi" title="Zoom +">‚ûï</button>
        <button class="cb" id="bZo" title="Zoom -">‚ûñ</button>
        <div class="cd"></div>
        <button class="cb" id="bFr" title="Anterior">üë§</button>
        <button class="cb" id="bTo" title="Superior">‚¨ÜÔ∏è</button>
        <button class="cb" id="bSi" title="Lateral">üëà</button>
        <button class="cb" id="bBk" title="Posterior">üîô</button>
        <div class="cd"></div>
        <button class="cb" id="bPP" title="Efectos">‚ú®</button>
        <button class="cb" id="bIn" title="Info">üìã</button>
    </div>

    <div class="pp-panel" id="ppP">
        <div class="hl-title">Post-Processing</div>
        <div class="pp-row"><label>Bloom</label><input type="range" id="ppB" min="0" max="100" value="10"></div>
        <div class="pp-row"><label>Exposici√≥n</label><input type="range" id="ppE" min="50" max="200" value="112"></div>
        <div class="pp-row"><label>SSS</label><input type="range" id="ppS" min="0" max="100" value="18"></div>
        <div class="pp-row"><label>Vignette</label><input type="range" id="ppV" min="0" max="100" value="30"></div>
    </div>

    <div class="credit">Modelo: <a href="https://sketchfab.com/3d-models/anatomy-study-skull-b6b4fa579a5e4da994b6caa1f18eb986" target="_blank">"Anatomy Study - Skull"</a> por Andr√© Mora<br>CC-BY-4.0</div>

    <script type="importmap">
    {"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"}}
    </script>
    <script type="module">
import * as THREE from 'three';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {EffectComposer} from 'three/addons/postprocessing/EffectComposer.js';
import {RenderPass} from 'three/addons/postprocessing/RenderPass.js';
import {UnrealBloomPass} from 'three/addons/postprocessing/UnrealBloomPass.js';
import {ShaderPass} from 'three/addons/postprocessing/ShaderPass.js';
import {SMAAPass} from 'three/addons/postprocessing/SMAAPass.js';

const $=id=>document.getElementById(id);
const lbFill=$('lbFill'), lbTxt=$('lbTxt'), ls=$('ls');
const setLoad=(p,t)=>{lbFill.style.width=p+'%';lbTxt.textContent=t};

setLoad(10,'Configurando escena...');
const canvas=$('mainCanvas');
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x09090b);
scene.fog=new THREE.FogExp2(0x09090b, 0.03);

const camera=new THREE.PerspectiveCamera(45, innerWidth/(innerHeight-52), 0.01, 100);
camera.position.set(3, 1.5, 4);

const renderer=new THREE.WebGLRenderer({canvas, antialias:true, powerPreference:'high-performance'});
renderer.setSize(innerWidth, innerHeight-52);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.12;
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.useLegacyLights=false;

const ctrl=new OrbitControls(camera, canvas);
ctrl.enableDamping=true; ctrl.dampingFactor=0.06;
ctrl.rotateSpeed=0.7; ctrl.zoomSpeed=0.8;
ctrl.minDistance=1.5; ctrl.maxDistance=10;
ctrl.target.set(0, 0, 0);
ctrl.autoRotate=true; ctrl.autoRotateSpeed=0.4;

setLoad(20,'Generando environment...');
const pmrem=new THREE.PMREMGenerator(renderer);
pmrem.compileEquirectangularShader();
const envSc=new THREE.Scene();
envSc.add(new THREE.Mesh(
    new THREE.SphereGeometry(10, 32, 32),
    new THREE.ShaderMaterial({
        side: THREE.BackSide,
        vertexShader:`varying vec3 vP;void main(){vP=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
        fragmentShader:`varying vec3 vP;void main(){
            vec3 d=normalize(vP);float y=d.y*.5+.5;
            vec3 c=mix(vec3(.035,.035,.04),mix(vec3(.055,.055,.06),vec3(.08,.078,.08),smoothstep(.4,1.,y)),smoothstep(0.,.4,y));
            c+=vec3(.18,.16,.10)*pow(max(0.,dot(d,normalize(vec3(1.,.5,.5)))),7.)*.18;
            c+=vec3(.06,.06,.08)*pow(max(0.,dot(d,normalize(vec3(-.7,.3,-.6)))),5.)*.12;
            gl_FragColor=vec4(c,1.);}`
    })
));
scene.environment=pmrem.fromScene(envSc, 0.04).texture;
pmrem.dispose();

setLoad(30,'Iluminaci√≥n...');
scene.add(new THREE.HemisphereLight(0x998880, 0x222218, 0.55));
const keyLight=new THREE.DirectionalLight(0xfff0dd, 2.8);
keyLight.position.set(4, 6, 6); keyLight.castShadow=true;
keyLight.shadow.mapSize.set(2048,2048);
keyLight.shadow.camera.near=0.1; keyLight.shadow.camera.far=20;
keyLight.shadow.camera.left=-4; keyLight.shadow.camera.right=4;
keyLight.shadow.camera.top=4; keyLight.shadow.camera.bottom=-4;
keyLight.shadow.bias=-0.0004; keyLight.shadow.normalBias=0.02;
scene.add(keyLight);
scene.add(new THREE.DirectionalLight(0x8899aa, 0.9).translateX(-5).translateY(3).translateZ(-2));
const rimLight=new THREE.DirectionalLight(0xccbb99, 1.2);
rimLight.position.set(-2,-1,-5); scene.add(rimLight);
const sssLight=new THREE.PointLight(0xbb9966, 0.35, 10);
sssLight.position.set(0,-3,2); scene.add(sssLight);
scene.add(new THREE.PointLight(0xffffff, 0.5, 12).translateX(2).translateY(3).translateZ(5));

setLoad(40,'Post-processing...');
const composer=new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom=new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight), 0.10, 0.4, 0.90);
composer.addPass(bloom);
const cgShader={
    uniforms:{tDiffuse:{value:null},sss:{value:0.18},vign:{value:0.30}},
    vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
    fragmentShader:`uniform sampler2D tDiffuse;uniform float sss;uniform float vign;varying vec2 vUv;
    void main(){vec4 tx=texture2D(tDiffuse,vUv);vec3 c=tx.rgb;
    float lum=dot(c,vec3(.299,.587,.114));float sm=smoothstep(.08,.45,lum)*(1.-smoothstep(.45,.85,lum));
    c+=vec3(.50,.45,.32)*sss*sm*.12;c.r+=.006;
    float g=dot(c,vec3(.2126,.7152,.0722));c=mix(vec3(g),c,1.06);c=(c-.5)*1.03+.5;
    vec2 u=vUv*2.-1.;c*=1.-dot(u,u)*vign*.4;gl_FragColor=vec4(clamp(c,0.,1.),tx.a);}`
};
const cgPass=new ShaderPass(cgShader);
composer.addPass(cgPass);
composer.addPass(new SMAAPass(innerWidth,innerHeight));

// ===== MESH CLASSIFICATION =====
// 42 meshes total. Classification by bounding box analysis:
// Cranium (large): 37,38,39,40 (neurocranium walls)
// Face/maxilla: 36,41 (viscerocranium/upper face)
// Sutures: 0,1,2,10,15,25,26,35 (thin lines along skull)
// Teeth anterior: 3-9,11-14,16-24 (small, z>0.6, in face region)
// Teeth posterior (molars): 27-34 (medium, further lateral)

const groups = {
    neurocranium: [37,38,39,40],
    viscerocranium: [36,41],
    teeth: [3,4,5,6,7,8,9,11,12,13,14,16,17,18,19,20,21,22,23,24,27,28,29,30,31,32,33,34],
    sutures: [0,1,2,10,15,25,26,35],
    // Individual bone info (highlight whole cranium, show info)
    frontal: [37,38,39,40],
    parietal: [37,38,39,40],
    temporal: [37,38,39,40],
    occipital: [37,38,39,40],
    sphenoid: [37,38,39,40],
    ethmoid: [37,38,39,40],
    maxilla: [36,41],
    mandible: [37,38,39,40],
    zygomatic: [36,41],
    nasal: [36,41],
    orbits: [36,41],
    fossae: [37,38,39,40],
    foramen: [37,38,39,40]
};

// ===== LOAD MODEL =====
setLoad(50,'Cargando cr√°neo...');
let model=null;
const allMeshes=[];

new GLTFLoader().load('skull.glb',
    (gltf) => {
        setLoad(80,'Mejorando materiales...');
        model = gltf.scene;
        const box=new THREE.Box3().setFromObject(model);
        const center=box.getCenter(new THREE.Vector3());
        const size=box.getSize(new THREE.Vector3());
        const sc=3.5/Math.max(size.x,size.y,size.z);
        model.scale.setScalar(sc);
        const sb=new THREE.Box3().setFromObject(model);
        const sc2=sb.getCenter(new THREE.Vector3());
        model.position.sub(sc2);

        let meshIdx=0;
        model.traverse(child=>{
            if(!child.isMesh) return;
            child.castShadow=true; child.receiveShadow=true;
            child._idx=meshIdx;
            allMeshes.push(child);
            meshIdx++;

            const isTeeth=groups.teeth.includes(child._idx);
            const isSuture=groups.sutures.includes(child._idx);

            const mat=child.material;
            const pm=new THREE.MeshPhysicalMaterial();
            if(mat.map) pm.map=mat.map;
            if(mat.normalMap){pm.normalMap=mat.normalMap;pm.normalScale=new THREE.Vector2(1.2,1.2);}
            pm.side=THREE.DoubleSide;

            if(isTeeth){
                pm.color=new THREE.Color(0.92,0.90,0.82);
                pm.roughness=0.35; pm.metalness=0.01;
                pm.clearcoat=0.25; pm.clearcoatRoughness=0.25;
                pm.sheen=0.2; pm.sheenRoughness=0.3;
                pm.sheenColor=new THREE.Color(0.9,0.88,0.78);
                pm.emissive=new THREE.Color(0.08,0.07,0.05); pm.emissiveIntensity=0.06;
                pm.envMapIntensity=0.5;
            } else if(isSuture){
                pm.color=new THREE.Color(0.45,0.40,0.32);
                pm.roughness=0.70; pm.metalness=0;
                pm.emissive=new THREE.Color(0.04,0.03,0.02); pm.emissiveIntensity=0.05;
                pm.envMapIntensity=0.3;
            } else {
                pm.color=new THREE.Color(0.72,0.68,0.58);
                pm.roughness=0.58; pm.metalness=0.02;
                pm.clearcoat=0.08; pm.clearcoatRoughness=0.50;
                pm.thickness=0.5; pm.attenuationColor=new THREE.Color(0.7,0.65,0.50);
                pm.attenuationDistance=3.0;
                pm.sheen=0.15; pm.sheenRoughness=0.55;
                pm.sheenColor=new THREE.Color(0.7,0.65,0.50);
                pm.emissive=new THREE.Color(0.06,0.05,0.03); pm.emissiveIntensity=0.06;
                pm.envMapIntensity=0.4;
            }
            child.material=pm;
        });

        scene.add(model);
        const gnd=new THREE.Mesh(new THREE.PlaneGeometry(18,18),
            new THREE.MeshStandardMaterial({color:0x09090b,roughness:0.95,transparent:true,opacity:0.4}));
        gnd.rotation.x=-Math.PI/2; gnd.position.y=sb.min.y-0.1; gnd.receiveShadow=true;
        scene.add(gnd);

        setLoad(100,'¬°Listo!');
        setTimeout(()=>ls.classList.add('hidden'),500);
    },
    p=>{if(p.total) setLoad(50+(p.loaded/p.total)*30,'Descargando... '+(p.loaded/1024|0)+'KB')},
    e=>{console.error(e);setLoad(0,'Error al cargar. Verifica que skull.glb est√© en la misma carpeta.')}
);

let lt=performance.now(),fc=0;
(function anim(t){
    requestAnimationFrame(anim); fc++;
    if(t-lt>=1000){$('fps').textContent=fc+' FPS';fc=0;lt=t;}
    ctrl.update(); sssLight.intensity=0.35+Math.sin(t*0.0007)*0.06;
    composer.render();
})(0);

addEventListener('resize',()=>{
    const w=innerWidth,h=innerHeight-52;
    camera.aspect=w/h;camera.updateProjectionMatrix();
    renderer.setSize(w,h);composer.setSize(w,h);bloom.setSize(w,h);
});

let ar=true;
$('bRot').onclick=e=>{ar=!ar;ctrl.autoRotate=ar;e.currentTarget.classList.toggle('active',ar)};
$('bRst').onclick=()=>{ctrl.target.set(0,0,0);camera.position.set(3,1.5,4)};
$('bZi').onclick=()=>camera.position.lerp(ctrl.target,0.15);
$('bZo').onclick=()=>{const d=camera.position.clone().sub(ctrl.target).normalize();camera.position.add(d.multiplyScalar(0.5))};
$('bFr').onclick=()=>{camera.position.set(0,0,5);ctrl.target.set(0,0,0)};
$('bTo').onclick=()=>{camera.position.set(0,5,0.01);ctrl.target.set(0,0,0)};
$('bSi').onclick=()=>{camera.position.set(5,0,0);ctrl.target.set(0,0,0)};
$('bBk').onclick=()=>{camera.position.set(0,0,-5);ctrl.target.set(0,0,0)};
let ipVis=true;
$('bIn').onclick=()=>{ipVis=!ipVis;$('ip').classList.toggle('hide',!ipVis)};
$('bPP').onclick=e=>{$('ppP').classList.toggle('vis');e.currentTarget.classList.toggle('active')};
$('ppB').oninput=e=>bloom.strength=e.target.value/100*0.5;
$('ppE').oninput=e=>renderer.toneMappingExposure=e.target.value/100;
$('ppS').oninput=e=>cgPass.uniforms.sss.value=e.target.value/100;
$('ppV').oninput=e=>cgPass.uniforms.vign.value=e.target.value/100;

// ===== HIGHLIGHT =====
function setHighlight(sel){
    const target=groups[sel];
    allMeshes.forEach(mesh=>{
        const mat=mesh.material; if(!mat) return;
        const idx=mesh._idx;
        if(sel==='all'){
            mat.transparent=false;mat.opacity=1;mat.depthWrite=true;
            mat.emissiveIntensity=groups.teeth.includes(idx)?0.06:groups.sutures.includes(idx)?0.05:0.06;
        } else if(target){
            const isTarget=target.includes(idx);
            mat.transparent=!isTarget;mat.opacity=isTarget?1:0.05;
            mat.depthWrite=isTarget;
            mat.emissiveIntensity=isTarget?0.18:0.01;
        }
    });
}

const partInfo={
    all:{n:'Cr√°neo Humano',s:'Sistema Esquel√©tico ‚Äî Cabeza',
        d:'Estructura √≥sea que protege el enc√©falo y aloja los √≥rganos de los sentidos. Compuesto por 22 huesos: 8 del neurocr√°neo (b√≥veda y base craneal) y 14 del viscerocr√°neo (esqueleto facial). Unidos por suturas (articulaciones fibrosas inm√≥viles) excepto la mand√≠bula, √∫nico hueso m√≥vil articulado por la ATM.',
        st:[{l:'Neurocr√°neo',v:'8 huesos'},{l:'Viscerocr√°neo',v:'14 huesos'},{l:'Capacidad',v:'~1400 cm¬≥'},{l:'Dientes',v:'32 (adulto)'}]},
    neurocranium:{n:'Neurocr√°neo',s:'B√≥veda y Base Craneal ‚Äî 8 Huesos',
        d:'Formado por 8 huesos que encierran y protegen el enc√©falo: frontal (1), parietales (2), temporales (2), occipital (1), esfenoides (1) y etmoides (1). La b√≥veda (calvaria) est√° formada por huesos planos con diploe (capa esponjosa entre dos tablas compactas). La base craneal presenta tres fosas (anterior, media, posterior).',
        st:[{l:'B√≥veda',v:'Frontal, parietales, occip.'},{l:'Base',v:'3 fosas craneales'},{l:'Diploe',v:'Esponjoso intermedio'},{l:'Grosor',v:'~5-7 mm'}]},
    viscerocranium:{n:'Viscerocr√°neo',s:'Esqueleto Facial ‚Äî 14 Huesos',
        d:'Compuesto por 14 huesos que forman la estructura de la cara: maxilares (2), cigom√°ticos (2), nasales (2), lagrimales (2), palatinos (2), cornetes nasales inferiores (2), v√≥mer (1) y mand√≠bula (1). Forman las cavidades orbitarias, nasales y oral, y proporcionan inserci√≥n a los m√∫sculos de la masticaci√≥n y expresi√≥n facial.',
        st:[{l:'Pares',v:'Maxilar, cigom√°tico, nasal...'},{l:'Impares',v:'V√≥mer, mand√≠bula'},{l:'Cavidades',v:'Orbital, nasal, oral'},{l:'Mand√≠bula',v:'√önico m√≥vil'}]},
    teeth:{n:'Dientes',s:'Aparato Dentario',
        d:'La dentici√≥n permanente adulta consta de 32 piezas: 8 incisivos (corte), 4 caninos (desgarro), 8 premolares (trituraci√≥n) y 12 molares (molienda, incluidas 4 muelas del juicio). Cada diente tiene corona (esmalte, el tejido m√°s duro del cuerpo), cuello y ra√≠z (cemento + ligamento periodontal insertado en el alv√©olo √≥seo).',
        st:[{l:'Incisivos',v:'8 (corte)'},{l:'Caninos',v:'4 (desgarro)'},{l:'Premolares',v:'8 (trituraci√≥n)'},{l:'Molares',v:'12 (molienda)'}]},
    sutures:{n:'Suturas Craneales',s:'Articulaciones Fibrosas',
        d:'Articulaciones inm√≥viles (sinartrosis) entre los huesos del cr√°neo. Principales: coronal (frontal-parietales), sagital (entre parietales), lambdoidea (parietales-occipital) y escamosa (temporal-parietal). En el neonato existen fontanelas (espacios membranosos): anterior (bregma, cierra ~18 meses) y posterior (lambda, cierra ~2 meses). Se osifican progresivamente con la edad.',
        st:[{l:'Coronal',v:'Frontal ‚Üî parietales'},{l:'Sagital',v:'Parietal ‚Üî parietal'},{l:'Lambdoidea',v:'Parietales ‚Üî occipital'},{l:'Fontanela ant.',v:'Cierra ~18 meses'}]},
    frontal:{n:'Hueso Frontal',s:'Neurocr√°neo ‚Äî Anterior',
        d:'Hueso impar que forma la frente, el techo de las √≥rbitas y la fosa craneal anterior. Contiene los senos frontales (neumatizaci√≥n que aligera el peso). Presenta los arcos superciliares, la glabela (punto craneom√©trico) y la escotadura/foramen supraorbitario (paso del nervio V1). Se articula con parietales, esfenoides, etmoides, nasales, lagrimales, maxilares y cigom√°ticos.',
        st:[{l:'Tipo',v:'Impar, plano'},{l:'Senos',v:'Frontales (neumatizaci√≥n)'},{l:'Fosa',v:'Craneal anterior'},{l:'Nervio',v:'V1 (supraorbitario)'}]},
    parietal:{n:'Huesos Parietales',s:'Neurocr√°neo ‚Äî Lateral Superior',
        d:'Par de huesos planos cuadril√°teros que forman la mayor parte de la b√≥veda craneal. Se articulan entre s√≠ (sutura sagital), con el frontal (sutura coronal), occipital (sutura lambdoidea) y temporal (sutura escamosa). Presentan la eminencia parietal (punto m√°s prominente) y surcos de la arteria men√≠ngea media en su cara interna.',
        st:[{l:'Tipo',v:'Par, plano'},{l:'Suturas',v:'Sagital, coronal, lambdoidea'},{l:'Eminencia',v:'Punto m√°s ancho'},{l:'Surcos internos',v:'A. men√≠ngea media'}]},
    temporal:{n:'Huesos Temporales',s:'Neurocr√°neo ‚Äî Lateral',
        d:'Huesos pares complejos con m√∫ltiples porciones: escamosa (fosa temporal), petrosa (contiene o√≠do interno y medio, conducto auditivo interno para nervios VII y VIII), mastoidea (ap√≥fisis mastoides con celdas a√©reas) y timp√°nica (conducto auditivo externo). Forman la cavidad glenoidea para la ATM y contienen el canal carot√≠deo.',
        st:[{l:'Porci√≥n petrosa',v:'O√≠do interno + medio'},{l:'ATM',v:'Cavidad glenoidea'},{l:'Ap√≥f. mastoides',v:'Inserci√≥n ECM'},{l:'Canal',v:'Carot√≠deo'}]},
    occipital:{n:'Hueso Occipital',s:'Neurocr√°neo ‚Äî Posterior',
        d:'Hueso impar que forma la parte posterior e inferior del cr√°neo. Presenta el foramen magnum (mayor orificio craneal, paso del bulbo raqu√≠deo y arterias vertebrales), los c√≥ndilos occipitales (articulaci√≥n atlanto-occipital que permite flexo-extensi√≥n de la cabeza), la protuberancia occipital externa (inion) y las l√≠neas nucales para inserci√≥n muscular.',
        st:[{l:'Foramen magnum',v:'Bulbo + vertebrales'},{l:'C√≥ndilos',v:'Art. atlanto-occipital'},{l:'Inion',v:'Protuberancia ext.'},{l:'L√≠neas nucales',v:'Inserciones musculares'}]},
    sphenoid:{n:'Hueso Esfenoides',s:'Neurocr√°neo ‚Äî Central (forma de murci√©lago)',
        d:'Hueso impar central, ¬´piedra angular¬ª del cr√°neo que articula con todos los dem√°s huesos craneales. Forma de murci√©lago con: cuerpo (contiene silla turca/fosa hipofisaria y senos esfenoidales), alas mayores (fosa craneal media), alas menores (fosa craneal anterior) y ap√≥fisis pterigoides. M√∫ltiples for√°menes: redondo (V2), oval (V3), espinoso (a. men√≠ngea media).',
        st:[{l:'Silla turca',v:'Hip√≥fisis'},{l:'Senos',v:'Esfenoidales'},{l:'F. redondo',v:'Nervio V2'},{l:'F. oval',v:'Nervio V3'}]},
    ethmoid:{n:'Hueso Etmoides',s:'Neurocr√°neo ‚Äî Anterior Central',
        d:'Hueso impar delicado en la l√≠nea media anterior de la base craneal. Formado por: l√°mina cribosa (techo de la cavidad nasal, paso de filetes del nervio olfatorio I), crista galli (inserci√≥n de la hoz del cerebro), l√°mina perpendicular (tabique nasal superior) y laberintos etmoidales (celdillas etmoidales y cornetes superior y medio).',
        st:[{l:'L√°mina cribosa',v:'Nervio olfatorio (I)'},{l:'Crista galli',v:'Hoz del cerebro'},{l:'Celdillas',v:'Etmoidales (senos)'},{l:'Cornetes',v:'Superior + medio'}]},
    maxilla:{n:'Maxilares',s:'Viscerocr√°neo ‚Äî Centro Facial',
        d:'Par de huesos que forman la mayor parte del esqueleto facial medio: piso de la √≥rbita, paredes laterales de la cavidad nasal, paladar duro (ap√≥fisis palatina) y alv√©olos dentarios superiores. Contienen los senos maxilares (los mayores senos paranasales). El foramen infraorbitario da paso al nervio V2. Su fractura (Le Fort I-III) es frecuente en traumatismos faciales.',
        st:[{l:'Seno maxilar',v:'Mayor seno paranasal'},{l:'Paladar duro',v:'Ap√≥f. palatina'},{l:'Nervio',v:'V2 (infraorbitario)'},{l:'Fracturas',v:'Le Fort I, II, III'}]},
    mandible:{n:'Mand√≠bula',s:'√önico Hueso M√≥vil del Cr√°neo',
        d:'Hueso impar, el m√°s fuerte y grande del viscerocr√°neo. √önico hueso m√≥vil del cr√°neo, articulado bilateralmente con los temporales por la ATM (articulaci√≥n sinovial bicond√≠lea). Consta de cuerpo (arco con alv√©olos para 16 dientes) y ramas ascendentes con c√≥ndilo (ATM) y ap√≥fisis coronoides (inserci√≥n del m√∫sculo temporal). Contiene el canal mandibular (nervio alveolar inferior, V3).',
        st:[{l:'ATM',v:'Sinovial bicond√≠lea'},{l:'Dientes',v:'16 inferiores'},{l:'Canal',v:'N. alveolar inf. (V3)'},{l:'M√∫sculo',v:'Masetero (m√°s fuerte)'}]},
    zygomatic:{n:'Huesos Cigom√°ticos',s:'P√≥mulos',
        d:'Par de huesos que forman la prominencia de los p√≥mulos y parte del piso y pared lateral de la √≥rbita. Se articulan con frontal, maxilar, temporal (arco cigom√°tico) y esfenoides. El arco cigom√°tico (cigom√°tico + ap√≥fisis cigom√°tica del temporal) da inserci√≥n al m√∫sculo masetero. El foramen cigom√°tico-facial da paso a ramos del V2.',
        st:[{l:'Arco cigom√°tico',v:'P√≥mulo + temporal'},{l:'√ìrbita',v:'Piso + pared lateral'},{l:'M√∫sculo',v:'Masetero (arco)'},{l:'Nervio',v:'Ramos de V2'}]},
    nasal:{n:'Huesos Nasales',s:'Puente de la Nariz',
        d:'Par de peque√±os huesos rectangulares que forman el puente √≥seo de la nariz. Se articulan entre s√≠ en la l√≠nea media, con el frontal superiormente, con los maxilares lateralmente y con la l√°mina perpendicular del etmoides posteriormente. Son los huesos m√°s frecuentemente fracturados de la cara. El nasion (punto de uni√≥n frontonasal) es un punto craneom√©trico importante.',
        st:[{l:'Tipo',v:'Par, peque√±o'},{l:'Fractura',v:'M√°s frecuente de la cara'},{l:'Nasion',v:'Punto craneom√©trico'},{l:'Articulaciones',v:'Frontal, maxilar, etmoides'}]},
    orbits:{n:'√ìrbitas',s:'Cavidades Orbitarias',
        d:'Cavidades piramidales que alojan los globos oculares, m√∫sculos extraoculares, nervios, vasos y grasa orbitaria. Formadas por 7 huesos: frontal (techo), maxilar (piso), cigom√°tico (pared lateral), esfenoides (ala mayor y menor), etmoides y lagrimal (pared medial), palatino (piso posterior). Fisura orbitaria superior (III, IV, V1, VI) y foramen √≥ptico (II, a. oft√°lmica).',
        st:[{l:'Huesos',v:'7 por √≥rbita'},{l:'Fisura sup.',v:'NC III, IV, V1, VI'},{l:'F. √≥ptico',v:'NC II + a. oft√°lmica'},{l:'Volumen',v:'~30 mL'}]},
    fossae:{n:'Fosas Craneales',s:'Base del Cr√°neo ‚Äî Tres Niveles',
        d:'La base craneal interna presenta tres escalones: fosa anterior (frontal + etmoides + esfenoides; aloja l√≥bulos frontales), fosa media (esfenoides + temporal; aloja l√≥bulos temporales y silla turca) y fosa posterior (occipital + temporal; aloja cerebelo, puente y bulbo). Cada fosa contiene for√°menes cr√≠ticos para nervios craneales y vasos.',
        st:[{l:'F. anterior',v:'L√≥bulos frontales'},{l:'F. media',v:'L. temporales + hip√≥fisis'},{l:'F. posterior',v:'Cerebelo + tronco'},{l:'For√°menes',v:'M√∫ltiples (NC I-XII)'}]},
    foramen:{n:'Foramen Magnum',s:'Mayor Orificio del Cr√°neo',
        d:'Orificio ovalado en la base del occipital (~35√ó30 mm) que comunica la cavidad craneal con el canal vertebral. Paso de: bulbo raqu√≠deo (transici√≥n a m√©dula espinal), arterias vertebrales, arterias espinales anteriores y posteriores, ra√≠ces espinales del nervio accesorio (XI) y meninges. Los c√≥ndilos occipitales flanquean lateralmente.',
        st:[{l:'Tama√±o',v:'~35√ó30 mm'},{l:'Contenido',v:'Bulbo + aa. vertebrales'},{l:'Nervio',v:'XI (ra√≠ces espinales)'},{l:'C√≥ndilos',v:'Art. atlanto-occipital'}]}
};

document.querySelectorAll('.hl-btn').forEach(btn=>{
    btn.onclick=()=>{
        document.querySelectorAll('.hl-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const p=btn.dataset.part,info=partInfo[p];
        if(info){
            $('ipN').textContent=info.n;$('ipS').textContent=info.s;$('ipD').textContent=info.d;
            $('ipSt').innerHTML=info.st.map(s=>`<div class="st-card"><div class="st-label">${s.l}</div><div class="st-val">${s.v}</div></div>`).join('');
        }
        setHighlight(p);
    };
});
    </script>
</body>
</html>
