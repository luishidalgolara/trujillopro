<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âcorch√© Anat√≥mico 3D ‚Äî Plataforma M√©dica In Silico</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0b0808;--panel:rgba(13,10,10,0.90);--card:rgba(22,16,16,0.75);--accent:#c45850;--accent-glow:rgba(196,88,80,0.22);--cyan:#58b4b8;--cyan-glow:rgba(88,180,184,0.18);--tendon:#c8a870;--text:#e8e0dc;--text2:#9a8e8a;--dim:#685854;--border:rgba(255,255,255,0.06);--glass:rgba(255,255,255,0.03)}
        body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;height:100vh}

        .header{position:fixed;top:0;left:0;right:0;height:52px;background:var(--panel);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:100}
        .header h1{font-size:.9rem;font-weight:600;letter-spacing:-.02em}
        .header span{font-family:'Space Mono',monospace;font-size:.6rem;color:var(--dim);text-transform:uppercase;letter-spacing:.1em}
        .header-r{display:flex;align-items:center;gap:14px}
        .sdot{width:6px;height:6px;border-radius:50%;background:#4ade80;box-shadow:0 0 8px rgba(74,222,128,.5);animation:pd 2s infinite}
        @keyframes pd{0%,100%{opacity:1}50%{opacity:.5}}
        .fps{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--dim)}

        #mainCanvas{position:fixed;top:52px;left:0;width:100%;height:calc(100vh - 52px)}

        .loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .8s,visibility .8s}
        .loading-screen.hidden{opacity:0;visibility:hidden;pointer-events:none}
        .lb-icon{font-size:3.5rem;animation:fl 2s ease-in-out infinite}
        @keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .lb-bar{width:180px;height:2px;background:var(--border);border-radius:2px;margin-top:20px;overflow:hidden}
        .lb-fill{height:100%;background:linear-gradient(90deg,#883830,var(--accent));width:0%;transition:width .3s;border-radius:2px}
        .lb-txt{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--dim);margin-top:10px}

        .info-panel{position:fixed;top:66px;right:14px;width:300px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:14px;padding:18px;z-index:50;transition:transform .4s cubic-bezier(.16,1,.3,1),opacity .4s}
        .info-panel.hide{transform:translateX(320px);opacity:0}
        .ip-tag{font-size:.6rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.12em;color:var(--accent);margin-bottom:10px}
        .ip-name{font-size:1.3rem;font-weight:700;letter-spacing:-.03em;margin-bottom:3px}
        .ip-sys{font-size:.78rem;color:var(--cyan);margin-bottom:10px}
        .ip-desc{font-size:.78rem;line-height:1.5;color:var(--text2);margin-bottom:14px}
        .ip-stats{display:grid;grid-template-columns:1fr 1fr;gap:7px}
        .st-card{background:var(--glass);border:1px solid var(--border);border-radius:9px;padding:9px 10px}
        .st-label{font-size:.6rem;color:var(--dim);font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.05em}
        .st-val{font-size:.85rem;font-weight:600;margin-top:1px}

        .hl-panel{position:fixed;top:66px;left:14px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:12px;z-index:50;max-height:calc(100vh - 160px);overflow-y:auto}
        .hl-panel::-webkit-scrollbar{width:4px}
        .hl-panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
        .hl-title{font-size:.6rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:8px}
        .hl-sep{font-size:.55rem;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin:8px 0 4px 10px;opacity:.6}
        .hl-btn{display:flex;align-items:center;gap:8px;width:100%;padding:7px 10px;border:1px solid transparent;border-radius:7px;background:0 0;color:var(--text2);font-size:.78rem;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;margin-bottom:2px}
        .hl-btn:hover{background:var(--glass);color:var(--text)}
        .hl-btn.active{background:var(--accent-glow);border-color:rgba(196,88,80,.3);color:var(--accent)}
        .hl-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

        .ctrl-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:5px;background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:7px;z-index:50}
        .cb{width:40px;height:40px;border-radius:9px;border:1px solid transparent;background:0 0;color:var(--text2);font-size:1.05rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .cb:hover{background:var(--glass);border-color:var(--border);color:var(--text)}
        .cb.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
        .cd{width:1px;background:var(--border);margin:4px 1px}

        .pp-panel{position:fixed;bottom:75px;left:50%;transform:translateX(-50%);background:var(--panel);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:13px;padding:14px;z-index:50;min-width:220px;display:none}
        .pp-panel.vis{display:block}
        .pp-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
        .pp-row label{font-size:.72rem;color:var(--text2)}
        .pp-row input[type=range]{width:100px;height:3px;-webkit-appearance:none;background:var(--border);border-radius:2px;outline:0}
        .pp-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--accent);cursor:pointer}

        .credit{position:fixed;bottom:70px;right:14px;font-size:.55rem;color:var(--dim);font-family:'Space Mono',monospace;z-index:50;text-align:right;line-height:1.4}
        .credit a{color:var(--dim);text-decoration:underline;text-decoration-color:rgba(255,255,255,.1)}

        /* Back button */
        .back-btn{
            display:flex;align-items:center;gap:7px;
            padding:0 12px;height:32px;
            background:rgba(255,255,255,0.04);
            border:1px solid rgba(255,255,255,0.06);
            border-radius:8px;
            color:var(--text2);
            font-family:'DM Sans',sans-serif;
            font-size:.75rem;font-weight:500;
            cursor:pointer;
            transition:all .25s ease;
            text-decoration:none;
            flex-shrink:0;
        }
        .back-btn:hover{
            background:rgba(255,255,255,0.08);
            border-color:rgba(255,255,255,0.12);
            color:var(--text);
        }
        .back-btn svg{
            width:14px;height:14px;
            opacity:.6;transition:all .25s ease;
        }
        .back-btn:hover svg{opacity:1;transform:translateX(-2px)}

        /* Labels toggle in ctrl-bar */
        .cb.lbl-active{
            background:var(--accent-glow) !important;
            border-color:var(--accent) !important;
            color:var(--accent) !important;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="ls">
        <div class="lb-icon">ü´Ä</div>
        <div class="lb-bar"><div class="lb-fill" id="lbFill"></div></div>
        <div class="lb-txt" id="lbTxt">Inicializando...</div>
    </div>

    <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
            <a href="../index.html" class="back-btn" title="Volver a m√≥dulos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
            </a>
            <span style="font-size:1.3rem">ü´Ä</span>
            <div><h1>Plataforma M√©dica In Silico</h1><span>Modelo Anat√≥mico 3D ‚Äî √âcorch√© (Estudio Muscular)</span></div>
        </div>
        <div class="header-r"><div class="fps" id="fps">-- FPS</div><div class="sdot"></div></div>
    </div>

    <canvas id="mainCanvas"></canvas>

    <div class="hl-panel">
        <div class="hl-title">Estructuras</div>
        <button class="hl-btn active" data-part="all"><span class="hl-dot" style="background:#c45850"></span>√âcorch√© completo</button>
        <div class="hl-sep">‚Äî Capas ‚Äî</div>
        <button class="hl-btn" data-part="muscles"><span class="hl-dot" style="background:#c44840"></span>Musculatura superficial</button>
        <button class="hl-btn" data-part="tendons"><span class="hl-dot" style="background:#c8a870"></span>Tendones y fascias</button>
        <button class="hl-btn" data-part="dissected"><span class="hl-dot" style="background:#aa6858"></span>Pierna disecada</button>
        <div class="hl-sep">‚Äî Regiones Musculares ‚Äî</div>
        <button class="hl-btn" data-part="head_neck"><span class="hl-dot" style="background:#cc5858"></span>Cabeza y cuello</button>
        <button class="hl-btn" data-part="thorax"><span class="hl-dot" style="background:#c85050"></span>T√≥rax</button>
        <button class="hl-btn" data-part="abdomen"><span class="hl-dot" style="background:#c44848"></span>Abdomen</button>
        <button class="hl-btn" data-part="back"><span class="hl-dot" style="background:#bb4040"></span>Dorso</button>
        <button class="hl-btn" data-part="upper_limb"><span class="hl-dot" style="background:#b83838"></span>Miembro superior</button>
        <button class="hl-btn" data-part="lower_limb"><span class="hl-dot" style="background:#b03030"></span>Miembro inferior</button>
        <div class="hl-sep">‚Äî M√∫sculos Clave ‚Äî</div>
        <button class="hl-btn" data-part="pectoralis"><span class="hl-dot" style="background:#dd6660"></span>Pectoral mayor</button>
        <button class="hl-btn" data-part="deltoid"><span class="hl-dot" style="background:#d46058"></span>Deltoides</button>
        <button class="hl-btn" data-part="biceps"><span class="hl-dot" style="background:#cc5850"></span>B√≠ceps braquial</button>
        <button class="hl-btn" data-part="rectus_abd"><span class="hl-dot" style="background:#c45048"></span>Recto abdominal</button>
        <button class="hl-btn" data-part="quadriceps"><span class="hl-dot" style="background:#bb4840"></span>Cu√°driceps</button>
        <button class="hl-btn" data-part="gastrocnemius"><span class="hl-dot" style="background:#b04038"></span>Gastrocnemio</button>
        <div class="hl-sep">‚Äî Conceptos ‚Äî</div>
        <button class="hl-btn" data-part="superficial"><span class="hl-dot" style="background:#58b4b8"></span>Plano superficial</button>
        <button class="hl-btn" data-part="deep"><span class="hl-dot" style="background:#4898a0"></span>Plano profundo</button>
    </div>

    <div class="info-panel" id="ip">
        <div class="ip-tag">Informaci√≥n Anat√≥mica</div>
        <div class="ip-name" id="ipN">√âcorch√© Anat√≥mico</div>
        <div class="ip-sys" id="ipS">Sistema Muscular</div>
        <div class="ip-desc" id="ipD">Representaci√≥n cl√°sica del cuerpo humano sin piel, exponiendo la musculatura superficial y profunda. El sistema muscular esquel√©tico comprende ~600 m√∫sculos que representan ~40% del peso corporal. Cada m√∫sculo tiene origen, inserci√≥n, inervaci√≥n y acci√≥n espec√≠ficos. La contracci√≥n muscular genera movimiento, estabiliza articulaciones y produce calor.</div>
        <div class="ip-stats" id="ipSt">
            <div class="st-card"><div class="st-label">M√∫sculos</div><div class="st-val">~600</div></div>
            <div class="st-card"><div class="st-label">Peso</div><div class="st-val">~40% corporal</div></div>
            <div class="st-card"><div class="st-label">Tipo</div><div class="st-val">Esquel√©tico estriado</div></div>
            <div class="st-card"><div class="st-label">Energ√≠a</div><div class="st-val">ATP (mitocondrial)</div></div>
        </div>
    </div>

    <div class="ctrl-bar">
        <button class="cb active" id="bRot" title="Auto-rotaci√≥n">üîÑ</button>
        <button class="cb" id="bRst" title="Reset">üè†</button>
        <div class="cd"></div>
        <button class="cb" id="bZi" title="Zoom +">‚ûï</button>
        <button class="cb" id="bZo" title="Zoom -">‚ûñ</button>
        <div class="cd"></div>
        <button class="cb" id="bFr" title="Anterior">üë§</button>
        <button class="cb" id="bTo" title="Superior">‚¨ÜÔ∏è</button>
        <button class="cb" id="bSi" title="Lateral">üëà</button>
        <button class="cb" id="bBk" title="Posterior">üîô</button>
        <div class="cd"></div>
        <button class="cb" id="bPP" title="Efectos">‚ú®</button>
        <button class="cb" id="bIn" title="Info">üìã</button>
        <div class="cd"></div>
        <button class="cb lbl-active" id="bLbl" title="Etiquetas num√©ricas">üè∑Ô∏è</button>
    </div>

    <div class="pp-panel" id="ppP">
        <div class="hl-title">Post-Processing</div>
        <div class="pp-row"><label>Bloom</label><input type="range" id="ppB" min="0" max="100" value="12"></div>
        <div class="pp-row"><label>Exposici√≥n</label><input type="range" id="ppE" min="50" max="200" value="115"></div>
        <div class="pp-row"><label>SSS</label><input type="range" id="ppS" min="0" max="100" value="30"></div>
        <div class="pp-row"><label>Vignette</label><input type="range" id="ppV" min="0" max="100" value="28"></div>
    </div>

    <div class="credit">Modelo: <a href="https://sketchfab.com/3d-models/ecorche-anatomy-study-e402d3d541eb4b199c57d5410f5d3c57" target="_blank">"Ecorche - Anatomy study"</a> por Beatriz Gomez Santamaria<br>CC-BY-4.0</div>

    <script type="importmap">
    {"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"}}
    </script>
    <script type="module">
import * as THREE from 'three';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {EffectComposer} from 'three/addons/postprocessing/EffectComposer.js';
import {RenderPass} from 'three/addons/postprocessing/RenderPass.js';
import {UnrealBloomPass} from 'three/addons/postprocessing/UnrealBloomPass.js';
import {ShaderPass} from 'three/addons/postprocessing/ShaderPass.js';
import {SMAAPass} from 'three/addons/postprocessing/SMAAPass.js';

const $=id=>document.getElementById(id);
const lbFill=$('lbFill'), lbTxt=$('lbTxt'), ls=$('ls');
const setLoad=(p,t)=>{lbFill.style.width=p+'%';lbTxt.textContent=t};

setLoad(10,'Configurando escena...');
const canvas=$('mainCanvas');
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x0b0808);
scene.fog=new THREE.FogExp2(0x0b0808, 0.02);

const camera=new THREE.PerspectiveCamera(45, innerWidth/(innerHeight-52), 0.01, 100);
camera.position.set(5, 2, 7);

const renderer=new THREE.WebGLRenderer({canvas, antialias:true, powerPreference:'high-performance'});
renderer.setSize(innerWidth, innerHeight-52);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.15;
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.useLegacyLights=false;

const ctrl=new OrbitControls(camera, canvas);
ctrl.enableDamping=true; ctrl.dampingFactor=0.06;
ctrl.rotateSpeed=0.7; ctrl.zoomSpeed=0.8;
ctrl.minDistance=2; ctrl.maxDistance=14;
ctrl.target.set(0, 0, 0);
ctrl.autoRotate=true; ctrl.autoRotateSpeed=0.4;

setLoad(20,'Generando environment...');
const pmrem=new THREE.PMREMGenerator(renderer);
pmrem.compileEquirectangularShader();
const envSc=new THREE.Scene();
envSc.add(new THREE.Mesh(
    new THREE.SphereGeometry(10, 32, 32),
    new THREE.ShaderMaterial({
        side: THREE.BackSide,
        vertexShader:`varying vec3 vP;void main(){vP=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
        fragmentShader:`varying vec3 vP;void main(){
            vec3 d=normalize(vP);float y=d.y*.5+.5;
            vec3 c=mix(vec3(.04,.03,.03),mix(vec3(.065,.045,.04),vec3(.09,.06,.055),smoothstep(.4,1.,y)),smoothstep(0.,.4,y));
            c+=vec3(.28,.14,.10)*pow(max(0.,dot(d,normalize(vec3(1.,.4,.5)))),7.)*.22;
            c+=vec3(.06,.06,.08)*pow(max(0.,dot(d,normalize(vec3(-.7,.2,-.6)))),5.)*.12;
            gl_FragColor=vec4(c,1.);}`
    })
));
scene.environment=pmrem.fromScene(envSc, 0.04).texture;
pmrem.dispose();

setLoad(30,'Iluminaci√≥n...');
scene.add(new THREE.HemisphereLight(0x998078, 0x221510, 0.55));
const keyLight=new THREE.DirectionalLight(0xffeedc, 2.8);
keyLight.position.set(5, 8, 6); keyLight.castShadow=true;
keyLight.shadow.mapSize.set(2048,2048);
keyLight.shadow.camera.near=0.1; keyLight.shadow.camera.far=25;
keyLight.shadow.camera.left=-5; keyLight.shadow.camera.right=5;
keyLight.shadow.camera.top=8; keyLight.shadow.camera.bottom=-5;
keyLight.shadow.bias=-0.0004; keyLight.shadow.normalBias=0.02;
scene.add(keyLight);
scene.add(new THREE.DirectionalLight(0x7788aa, 0.9).translateX(-6).translateY(4).translateZ(-3));
const rimLight=new THREE.DirectionalLight(0xdd9977, 1.3);
rimLight.position.set(-3,-2,-6); scene.add(rimLight);
const sssLight=new THREE.PointLight(0xcc5544, 0.40, 14);
sssLight.position.set(0,-4,3); scene.add(sssLight);
scene.add(new THREE.PointLight(0xffffff, 0.50, 16).translateX(3).translateY(5).translateZ(5));

setLoad(40,'Post-processing...');
const composer=new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom=new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight), 0.12, 0.42, 0.88);
composer.addPass(bloom);
const cgShader={
    uniforms:{tDiffuse:{value:null},sss:{value:0.30},vign:{value:0.28}},
    vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
    fragmentShader:`uniform sampler2D tDiffuse;uniform float sss;uniform float vign;varying vec2 vUv;
    void main(){vec4 tx=texture2D(tDiffuse,vUv);vec3 c=tx.rgb;
    float lum=dot(c,vec3(.299,.587,.114));float sm=smoothstep(.06,.40,lum)*(1.-smoothstep(.40,.82,lum));
    c+=vec3(.80,.35,.28)*sss*sm*.18;c.r+=.012;
    float g=dot(c,vec3(.2126,.7152,.0722));c=mix(vec3(g),c,1.10);c=(c-.5)*1.04+.5;
    vec2 u=vUv*2.-1.;c*=1.-dot(u,u)*vign*.4;gl_FragColor=vec4(clamp(c,0.,1.),tx.a);}`
};
const cgPass=new ShaderPass(cgShader);
composer.addPass(cgPass);
composer.addPass(new SMAAPass(innerWidth,innerHeight));

const meshGroups = { muscles: [], tendons: [], dissected: [] };

setLoad(50,'Cargando √©corch√©...');
let model=null;
const allMeshes=[];

new GLTFLoader().load('ecorche.glb',
    (gltf) => {
        setLoad(80,'Mejorando materiales...');
        model = gltf.scene;
        const box=new THREE.Box3().setFromObject(model);
        const size=box.getSize(new THREE.Vector3());
        const sc=5.5/Math.max(size.x,size.y,size.z);
        model.scale.setScalar(sc);
        const sb=new THREE.Box3().setFromObject(model);
        const sc2=sb.getCenter(new THREE.Vector3());
        model.position.sub(sc2);

        let meshIdx=0;
        model.traverse(child=>{
            if(!child.isMesh) return;
            child.castShadow=true; child.receiveShadow=true;
            child._idx=meshIdx;
            allMeshes.push(child);

            if(meshIdx<=3) meshGroups.muscles.push(child);
            else if(meshIdx===4) meshGroups.tendons.push(child);
            else meshGroups.dissected.push(child);

            const pm=new THREE.MeshPhysicalMaterial();
            pm.side=THREE.DoubleSide;

            if(meshIdx<=3){
                pm.color=new THREE.Color(0.62, 0.22, 0.18);
                pm.roughness=0.48; pm.metalness=0.07;
                pm.clearcoat=0.12; pm.clearcoatRoughness=0.40;
                pm.thickness=1.2; pm.attenuationColor=new THREE.Color(0.6,0.12,0.10);
                pm.attenuationDistance=1.5;
                pm.sheen=0.30; pm.sheenRoughness=0.40;
                pm.sheenColor=new THREE.Color(0.7,0.30,0.25);
                pm.emissive=new THREE.Color(0.12,0.04,0.03); pm.emissiveIntensity=0.10;
                pm.envMapIntensity=0.45;
            } else if(meshIdx===4){
                pm.color=new THREE.Color(0.75, 0.65, 0.52);
                pm.roughness=0.85; pm.metalness=0;
                pm.sheen=0.10; pm.sheenRoughness=0.70;
                pm.sheenColor=new THREE.Color(0.8,0.72,0.58);
                pm.emissive=new THREE.Color(0.06,0.04,0.03); pm.emissiveIntensity=0.06;
                pm.envMapIntensity=0.3;
            } else {
                pm.color=new THREE.Color(0.55, 0.20, 0.18);
                pm.roughness=0.55; pm.metalness=0;
                pm.clearcoat=0.08; pm.clearcoatRoughness=0.50;
                pm.thickness=0.8; pm.attenuationColor=new THREE.Color(0.5,0.10,0.08);
                pm.attenuationDistance=1.0;
                pm.sheen=0.20; pm.sheenRoughness=0.50;
                pm.sheenColor=new THREE.Color(0.6,0.25,0.22);
                pm.emissive=new THREE.Color(0.10,0.03,0.03); pm.emissiveIntensity=0.08;
                pm.envMapIntensity=0.4;
            }
            child.material=pm;
            meshIdx++;
        });

        scene.add(model);
        const gnd=new THREE.Mesh(new THREE.PlaneGeometry(24,24),
            new THREE.MeshStandardMaterial({color:0x0b0808,roughness:0.95,transparent:true,opacity:0.4}));
        gnd.rotation.x=-Math.PI/2; gnd.position.y=sb.min.y-0.12; gnd.receiveShadow=true;
        scene.add(gnd);

        setLoad(100,'¬°Listo!');
        setTimeout(()=>ls.classList.add('hidden'),500);
    },
    p=>{if(p.total) setLoad(50+(p.loaded/p.total)*30,'Descargando... '+(p.loaded/1024|0)+'KB')},
    e=>{console.error(e);setLoad(0,'Error al cargar. Verifica que ecorche.glb est√© en la misma carpeta.')}
);

// ===== EXPOSE FOR EXTERNAL MODULES =====
window.__ECORCHE3D = { scene, camera, renderer, ctrl };

let lt=performance.now(),fc=0;
(function anim(t){
    requestAnimationFrame(anim); fc++;
    if(t-lt>=1000){$('fps').textContent=fc+' FPS';fc=0;lt=t;}
    ctrl.update(); sssLight.intensity=0.40+Math.sin(t*0.0008)*0.07;
    composer.render();
})(0);

addEventListener('resize',()=>{
    const w=innerWidth,h=innerHeight-52;
    camera.aspect=w/h;camera.updateProjectionMatrix();
    renderer.setSize(w,h);composer.setSize(w,h);bloom.setSize(w,h);
});

let ar=true;
$('bRot').onclick=e=>{ar=!ar;ctrl.autoRotate=ar;e.currentTarget.classList.toggle('active',ar)};
$('bRst').onclick=()=>{ctrl.target.set(0,0,0);camera.position.set(5,2,7)};
$('bZi').onclick=()=>camera.position.lerp(ctrl.target,0.15);
$('bZo').onclick=()=>{const d=camera.position.clone().sub(ctrl.target).normalize();camera.position.add(d.multiplyScalar(0.6))};
$('bFr').onclick=()=>{camera.position.set(0,0,8);ctrl.target.set(0,0,0)};
$('bTo').onclick=()=>{camera.position.set(0,8,0.01);ctrl.target.set(0,0,0)};
$('bSi').onclick=()=>{camera.position.set(8,0,0);ctrl.target.set(0,0,0)};
$('bBk').onclick=()=>{camera.position.set(0,0,-8);ctrl.target.set(0,0,0)};
let ipVis=true;
$('bIn').onclick=()=>{ipVis=!ipVis;$('ip').classList.toggle('hide',!ipVis)};
$('bPP').onclick=e=>{$('ppP').classList.toggle('vis');e.currentTarget.classList.toggle('active')};
$('ppB').oninput=e=>bloom.strength=e.target.value/100*0.5;
$('ppE').oninput=e=>renderer.toneMappingExposure=e.target.value/100;
$('ppS').oninput=e=>cgPass.uniforms.sss.value=e.target.value/100;
$('ppV').oninput=e=>cgPass.uniforms.vign.value=e.target.value/100;

const groupMap={
    muscles:['muscles'],tendons:['tendons'],dissected:['dissected'],
    head_neck:['muscles'],thorax:['muscles'],abdomen:['muscles'],back:['muscles'],
    upper_limb:['muscles'],lower_limb:['muscles','dissected'],
    pectoralis:['muscles'],deltoid:['muscles'],biceps:['muscles'],rectus_abd:['muscles'],
    quadriceps:['muscles','dissected'],gastrocnemius:['muscles','dissected'],
    superficial:['muscles'],deep:['tendons','dissected']
};

function setHighlight(sel){
    const targets=groupMap[sel];
    allMeshes.forEach(mesh=>{
        const mat=mesh.material; if(!mat) return;
        const grp=mesh._idx<=3?'muscles':mesh._idx===4?'tendons':'dissected';
        if(sel==='all'){
            mat.transparent=false;mat.opacity=1;mat.depthWrite=true;
            mat.emissiveIntensity=(grp==='muscles')?0.10:(grp==='tendons')?0.06:0.08;
        } else if(targets){
            const isTarget=targets.includes(grp);
            mat.transparent=!isTarget;mat.opacity=isTarget?1:0.06;
            mat.depthWrite=isTarget;
            mat.emissiveIntensity=isTarget?0.20:0.02;
        }
    });
}

const partInfo={
    all:{n:'√âcorch√© Anat√≥mico',s:'Sistema Muscular',
        d:'Representaci√≥n cl√°sica del cuerpo humano sin piel, exponiendo la musculatura superficial y profunda. El sistema muscular esquel√©tico comprende ~600 m√∫sculos que representan ~40% del peso corporal. Cada m√∫sculo tiene origen, inserci√≥n, inervaci√≥n y acci√≥n espec√≠ficos. La contracci√≥n muscular genera movimiento, estabiliza articulaciones y produce calor.',
        st:[{l:'M√∫sculos',v:'~600'},{l:'Peso',v:'~40% corporal'},{l:'Tipo',v:'Esquel√©tico estriado'},{l:'Energ√≠a',v:'ATP (mitocondrial)'}]},
    muscles:{n:'Musculatura Superficial',s:'Capa Muscular Externa',
        d:'Los m√∫sculos superficiales son los m√°s visibles bajo la piel y definen la forma corporal externa. Incluyen los grandes motores del movimiento: pectorales, deltoides, b√≠ceps, tr√≠ceps, dorsal ancho, recto abdominal, oblicuos, cu√°driceps, isquiotibiales y gastrocnemios. Est√°n envueltos por la fascia profunda y separados en compartimentos funcionales.',
        st:[{l:'Fascia',v:'Profunda (envuelve)'},{l:'Compartimentos',v:'Funcionales'},{l:'Fibras',v:'Tipo I (lentas) + II (r√°pidas)'},{l:'Inervaci√≥n',v:'Nervios espinales'}]},
    tendons:{n:'Tendones y Fascias',s:'Tejido Conectivo Denso',
        d:'Los tendones conectan m√∫sculo a hueso, transmitiendo la fuerza de contracci√≥n. Compuestos de col√°geno tipo I organizado en fasc√≠culos paralelos (alta resistencia a la tracci√≥n). Las fascias son l√°minas de tejido conectivo que envuelven y separan m√∫sculos en compartimentos. Las aponeurosis son tendones laminares amplios (ej: aponeurosis abdominal).',
        st:[{l:'Col√°geno',v:'Tipo I (90%)'},{l:'Resistencia',v:'~50-100 MPa'},{l:'Fascia',v:'Separa compartimentos'},{l:'Aponeurosis',v:'Tend√≥n laminar'}]},
    dissected:{n:'Pierna Disecada',s:'Plano Profundo Expuesto',
        d:'Vista del miembro inferior con disecci√≥n profunda que expone los m√∫sculos por debajo de la fascia lata. Permite observar la relaci√≥n entre los compartimentos anterior (cu√°driceps, sartorio), medial (aductores), posterior (isquiotibiales) y los paquetes vasculonerviosos (arteria/vena femoral, nervio ci√°tico).',
        st:[{l:'Comp. anterior',v:'Cu√°driceps, sartorio'},{l:'Comp. medial',v:'Aductores'},{l:'Comp. posterior',v:'Isquiotibiales'},{l:'Nervio',v:'Ci√°tico (el mayor)'}]},
    head_neck:{n:'M√∫sculos de Cabeza y Cuello',s:'Expresi√≥n, Masticaci√≥n y Movimiento Cervical',
        d:'Incluyen los m√∫sculos de la expresi√≥n facial (orbicular de los ojos, cigom√°tico, orbicular de la boca, buccinador), de la masticaci√≥n (masetero, temporal, pterigoideos), suprahioideos e infrahioideos (degluci√≥n), y los del cuello: esternocleidomastoideo (ECM, rotaci√≥n e inclinaci√≥n) y escalenos (respiraci√≥n accesoria).',
        st:[{l:'Expresi√≥n',v:'~20 m√∫sculos faciales'},{l:'Masticaci√≥n',v:'Masetero (m√°s fuerte ratio)'},{l:'ECM',v:'Rotaci√≥n cervical'},{l:'Escalenos',v:'Resp. accesoria'}]},
    thorax:{n:'M√∫sculos del T√≥rax',s:'Respiraci√≥n y Movimiento del Brazo',
        d:'Pectoral mayor (aducci√≥n, flexi√≥n y rotaci√≥n interna del brazo), pectoral menor (deprime esc√°pula), serrato anterior (protracci√≥n escapular, "m√∫sculo del boxeador"), intercostales externos (inspiraci√≥n) e internos (espiraci√≥n forzada). El diafragma, principal m√∫sculo inspiratorio, separa t√≥rax de abdomen.',
        st:[{l:'Pectoral mayor',v:'Aducci√≥n + rot. interna'},{l:'Serrato anterior',v:'Protracci√≥n escapular'},{l:'Intercostales',v:'Respiraci√≥n'},{l:'Diafragma',v:'Inspiraci√≥n principal'}]},
    abdomen:{n:'M√∫sculos del Abdomen',s:'Pared Abdominal',
        d:'Cuatro capas: recto abdominal (flexi√≥n del trunco, "six-pack"), oblicuo externo (rotaci√≥n contralateral), oblicuo interno (rotaci√≥n ipsilateral) y transverso abdominal (compresi√≥n visceral, estabilizaci√≥n del core). La l√≠nea alba divide los rectos. Las intersecciones tendinosas crean los segmentos visibles del recto.',
        st:[{l:'Recto abdominal',v:'Flexi√≥n del tronco'},{l:'Oblicuo externo',v:'Rotaci√≥n contralateral'},{l:'Transverso',v:'Estabilizaci√≥n core'},{l:'L√≠nea alba',v:'Divide los rectos'}]},
    back:{n:'M√∫sculos del Dorso',s:'Extensi√≥n y Postura',
        d:'Capa superficial: trapecio (elevaci√≥n/retracci√≥n/depresi√≥n escapular) y dorsal ancho (extensi√≥n, aducci√≥n y rotaci√≥n interna del brazo, "m√∫sculo del nadador"). Capa profunda: erectores de la columna (iliocostal, long√≠simo, espinoso) que mantienen la postura erguida y extienden la columna.',
        st:[{l:'Trapecio',v:'3 porciones (escapular)'},{l:'Dorsal ancho',v:'M√∫sculo m√°s ancho'},{l:'Erectores',v:'Postura + extensi√≥n'},{l:'Suboccipitales',v:'Mov. finos cabeza'}]},
    upper_limb:{n:'M√∫sculos del Miembro Superior',s:'Movilidad y Prensi√≥n',
        d:'Hombro: deltoides (abducci√≥n 15¬∞-90¬∞), manguito rotador (supraespinoso, infraespinoso, redondo menor, subescapular). Brazo: b√≠ceps braquial (flexi√≥n + supinaci√≥n), tr√≠ceps (extensi√≥n). Antebrazo: flexores y extensores del carpo y dedos, pronadores y supinadores. Mano: intr√≠nsecos.',
        st:[{l:'Deltoides',v:'Abducci√≥n brazo'},{l:'Manguito rotador',v:'4 m√∫sculos (SITS)'},{l:'B√≠ceps',v:'Flexi√≥n + supinaci√≥n'},{l:'Tr√≠ceps',v:'Extensi√≥n del codo'}]},
    lower_limb:{n:'M√∫sculos del Miembro Inferior',s:'Locomoci√≥n y Soporte',
        d:'Cadera: gl√∫teo mayor (extensi√≥n, el m√°s potente), gl√∫teo medio (abducci√≥n, marcha), iliopsoas (flexi√≥n). Muslo: cu√°driceps (extensi√≥n rodilla), isquiotibiales (flexi√≥n rodilla + extensi√≥n cadera), aductores. Pierna: gastrocnemio y s√≥leo (flexi√≥n plantar), tibial anterior (dorsiflexi√≥n).',
        st:[{l:'Gl√∫teo mayor',v:'M√°s potente del cuerpo'},{l:'Cu√°driceps',v:'Extensi√≥n rodilla'},{l:'Isquiotibiales',v:'Flexi√≥n rodilla'},{l:'Tr√≠ceps sural',v:'Flexi√≥n plantar'}]},
    pectoralis:{n:'Pectoral Mayor',s:'M√∫sculo Anterior del T√≥rax',
        d:'Gran m√∫sculo en abanico con tres porciones: clavicular (flexi√≥n del brazo), esternocostal (aducci√≥n) y abdominal. Origen: clav√≠cula medial, estern√≥n, costillas 1-6 y aponeurosis del oblicuo. Inserci√≥n: cresta del tub√©rculo mayor del h√∫mero. Inervaci√≥n: nervios pectorales medial y lateral (C5-T1).',
        st:[{l:'Origen',v:'Clav√≠cula, estern√≥n, costillas'},{l:'Inserci√≥n',v:'H√∫mero (tub. mayor)'},{l:'Nervio',v:'Pectorales (C5-T1)'},{l:'Acci√≥n',v:'Aducci√≥n + rot. interna'}]},
    deltoid:{n:'Deltoides',s:'M√∫sculo del Hombro',
        d:'M√∫sculo triangular grueso que cubre la articulaci√≥n glenohumeral. Tres porciones: anterior (flexi√≥n + rotaci√≥n interna), media (abducci√≥n pura 15¬∞-90¬∞), posterior (extensi√≥n + rotaci√≥n externa). Origen: clav√≠cula lateral, acromion, espina escapular. Inserci√≥n: tuberosidad deltoidea del h√∫mero. Nervio axilar (C5-C6).',
        st:[{l:'Porciones',v:'3 (ant., media, post.)'},{l:'Acci√≥n principal',v:'Abducci√≥n 15¬∞-90¬∞'},{l:'Nervio',v:'Axilar (C5-C6)'},{l:'Inserci√≥n',v:'Tuberosidad deltoidea'}]},
    biceps:{n:'B√≠ceps Braquial',s:'Flexor del Codo y Supinador',
        d:'M√∫sculo superficial del compartimento anterior del brazo con dos cabezas: larga (tub√©rculo supraglenoideo) y corta (ap√≥fisis coracoides). Se inserta en la tuberosidad del radio y aponeurosis bicipital. Flexiona el codo y es el supinador m√°s potente del antebrazo. Nervio musculocut√°neo (C5-C6).',
        st:[{l:'Cabezas',v:'2 (larga + corta)'},{l:'Inserci√≥n',v:'Tuberosidad radial'},{l:'Acci√≥n',v:'Flexi√≥n + supinaci√≥n'},{l:'Nervio',v:'Musculocut√°neo (C5-C6)'}]},
    rectus_abd:{n:'Recto Abdominal',s:'Flexor del Tronco ‚Äî "Six-Pack"',
        d:'M√∫sculo par y largo que va del pubis al t√≥rax (ap√≥fisis xifoides y cart√≠lagos costales 5-7). Dividido por intersecciones tendinosas transversas (3-4) que crean los segmentos visibles. Envuelto por la vaina del recto. Principal flexor del tronco. Inervado por nervios intercostales (T7-T12).',
        st:[{l:'Origen',v:'Pubis (s√≠nfisis + cresta)'},{l:'Inserci√≥n',v:'Xifoides + costillas 5-7'},{l:'Intersecciones',v:'3-4 tendinosas'},{l:'Nervios',v:'Intercostales T7-T12'}]},
    quadriceps:{n:'Cu√°driceps Femoral',s:'Extensor de la Rodilla ‚Äî M√°s Voluminoso',
        d:'Grupo de 4 m√∫sculos del compartimento anterior del muslo: recto femoral (biarticular), vasto lateral, vasto medial y vasto intermedio. Se unen en el tend√≥n cuadricipital ‚Üí r√≥tula ‚Üí tend√≥n rotuliano ‚Üí tuberosidad tibial. Es el m√∫sculo m√°s voluminoso del cuerpo. Nervio femoral (L2-L4).',
        st:[{l:'Cabezas',v:'4 (recto + 3 vastos)'},{l:'Tend√≥n',v:'Cuadricipital ‚Üí rotuliano'},{l:'Nervio',v:'Femoral (L2-L4)'},{l:'Volumen',v:'M√°s grande del cuerpo'}]},
    gastrocnemius:{n:'Gastrocnemio',s:'M√∫sculo de la Pantorrilla',
        d:'M√∫sculo superficial biarticular de la pantorrilla con dos cabezas (medial y lateral) que se originan en los c√≥ndilos femorales. Se une al s√≥leo formando el tend√≥n calc√°neo (de Aquiles), el m√°s fuerte del cuerpo. Potente flexor plantar. Nervio tibial (S1-S2).',
        st:[{l:'Cabezas',v:'2 (medial + lateral)'},{l:'Tend√≥n',v:'Aquiles (el m√°s fuerte)'},{l:'Acci√≥n',v:'Flexi√≥n plantar potente'},{l:'Nervio',v:'Tibial (S1-S2)'}]},
    superficial:{n:'Plano Superficial',s:'M√∫sculos Visibles Bajo la Piel',
        d:'El plano superficial incluye todos los m√∫sculos visibles externamente una vez retirada la piel y el tejido subcut√°neo. Est√°n envueltos por la fascia profunda. Son los principales responsables de la forma corporal visible y los movimientos amplios.',
        st:[{l:'Fascia',v:'Profunda (envolvente)'},{l:'Art√≠stico',v:'Define forma corporal'},{l:'Cirug√≠a',v:'Colgajos musculares'},{l:'Evaluaci√≥n',v:'Tono, trofismo'}]},
    deep:{n:'Plano Profundo',s:'M√∫sculos y Tendones Subyacentes',
        d:'Bajo los m√∫sculos superficiales se encuentran los m√∫sculos profundos (estabilizadores, rotadores), los tendones largos, las fascias intermusculares que forman compartimentos, y los paquetes vasculonerviosos. Los compartimentos cerrados son cl√≠nicamente importantes.',
        st:[{l:'Estabilizadores',v:'Rotadores, mult√≠fidos'},{l:'Compartimentos',v:'Cerrados por fascia'},{l:'S√≠nd. compartimental',v:'Urgencia quir√∫rgica'},{l:'Fasciotom√≠a',v:'Tratamiento: abrir fascia'}]}
};

document.querySelectorAll('.hl-btn').forEach(btn=>{
    btn.onclick=()=>{
        document.querySelectorAll('.hl-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const p=btn.dataset.part,info=partInfo[p];
        if(info){
            $('ipN').textContent=info.n;$('ipS').textContent=info.s;$('ipD').textContent=info.d;
            $('ipSt').innerHTML=info.st.map(s=>`<div class="st-card"><div class="st-label">${s.l}</div><div class="st-val">${s.v}</div></div>`).join('');
        }
        setHighlight(p);
    };
});
    </script>
    <!-- ‚ïê‚ïê‚ïê M√ìDULO: Etiquetas Anat√≥micas Numeradas ‚ïê‚ïê‚ïê -->
    <script type="module" src="../js/labels/ecorche/ecorche_labels.js"></script>
    <!-- ‚ïê‚ïê‚ïê M√ìDULOS: Datos M√©dicos Extendidos ‚ïê‚ïê‚ïê -->
    <script src="../js/labels/ecorche/ecorche_patologias.js"></script>
    <script src="../js/labels/ecorche/ecorche_nutricion.js"></script>
    <script src="../js/labels/ecorche/ecorche_habitos.js"></script>
    <script src="../js/labels/ecorche/ecorche_anatomia.js"></script>
    <script src="../js/labels/ecorche/ecorche_fisiologia.js"></script>
    <script src="../js/labels/ecorche/ecorche_clinicos.js"></script>
    <!-- ‚ïê‚ïê‚ïê M√ìDULO: Orquestador UI Info M√©dica ‚ïê‚ïê‚ïê -->
    <script src="../js/labels/ecorche/ecorche_medical_info.js"></script>
</body>
</html>